<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Senior - Gestion des Pr√©sences</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Firebase SDKs -->
    <script type="module">
        try {
            console.log('üî• Chargement des modules Firebase...');
            
            // Import the functions you need from the SDKs you need
            const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js');
            const { getFirestore, collection, doc, setDoc, getDoc, onSnapshot, updateDoc, deleteDoc } = await import('https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js');
            const { getAuth, signInAnonymously, onAuthStateChanged } = await import('https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js');
            
            console.log('‚úÖ Modules Firebase charg√©s');
            
            // Your web app's Firebase configuration
            const firebaseConfig = {
                apiKey: "AIzaSyATLw5LsQ-8DpDMhoRT899g1M0-9BsMxuI",
                authDomain: "senior-20e40.firebaseapp.com",
                projectId: "senior-20e40",
                storageBucket: "senior-20e40.firebasestorage.app",
                messagingSenderId: "370305614271",
                appId: "1:370305614271:web:b43a2c7fc107b410e6e10a",
                measurementId: "G-JSR540HEDB"
            };
            
            console.log('üîÑ Initialisation Firebase...');
            
            // Initialize Firebase
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);
            
            console.log('‚úÖ Firebase initialis√©');
            
            // Make Firebase services available globally
            window.db = db;
            window.auth = auth;
            window.firebaseServices = {
                collection,
                doc,
                setDoc,
                getDoc,
                onSnapshot,
                updateDoc,
                deleteDoc,
                signInAnonymously,
                onAuthStateChanged
            };
            
            console.log('‚úÖ Services Firebase disponibles globalement');
            
        } catch (error) {
            console.error('‚ùå Erreur chargement Firebase:', error);
            window.firebaseError = error;
        }
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            padding: 30px;
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 3em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.3em;
            opacity: 0.9;
        }

        .nav-tabs {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .tab-button {
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            background: rgba(255,255,255,0.9);
            color: #667eea;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 16px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .tab-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            background: white;
        }

        .tab-button.active {
            background: white;
            color: #764ba2;
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }

        .tab-content {
            display: none;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            animation: fadeIn 0.5s ease-in-out;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #667eea;
        }

        .section-title {
            font-size: 2.2em;
            color: #333;
            font-weight: 700;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 14px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #333;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-number {
            font-size: 3em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .presence-grid {
            overflow-x: auto;
            margin: 30px 0;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .presence-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: white;
        }

        .presence-table th {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px 10px;
            text-align: center;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            white-space: nowrap;
        }

        .presence-table th:first-child {
            position: sticky;
            left: 0;
            z-index: 11;
            width: 120px;
            min-width: 120px;
        }

        .presence-table th:nth-child(2) {
            position: sticky;
            left: 120px;
            z-index: 11;
            width: 120px;
            min-width: 120px;
        }

        .presence-table td {
            padding: 12px 10px;
            text-align: center;
            border-bottom: 1px solid #eee;
            border-right: 1px solid #eee;
            position: relative;
        }

        .presence-table td:first-child {
            position: sticky;
            left: 0;
            z-index: 5;
            background: #f8f9ff;
            font-weight: 600;
            text-align: left;
            width: 120px;
            min-width: 120px;
            padding-left: 15px;
        }

        .presence-table td:nth-child(2) {
            position: sticky;
            left: 120px;
            z-index: 5;
            background: #f8f9ff;
            font-weight: 600;
            text-align: left;
            width: 120px;
            min-width: 120px;
            padding-left: 15px;
        }

        .presence-table tr:hover td {
            background: #f0f4ff;
        }

        .presence-cell {
            width: 80px;
            height: 40px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .presence-cell:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .status-abp {
            background: #ffcdd2;
            color: #d32f2f;
        }

        .status-absp {
            background: #d32f2f;
            color: white;
        }

        .status-bls {
            background: #ffcc80;
            color: #f57c00;
        }

        .status-vac {
            background: #f8bbd9;
            color: #c2185b;
        }

        .status-pst {
            background: #c8e6c9;
            color: #2e7d32;
        }

        .status-ca {
            background: #1976d2;
            color: white;
        }

        .status-cb {
            background: #42a5f5;
            color: white;
        }

        .status-cc {
            background: #90caf9;
            color: #1976d2;
        }

        .status-ret {
            background: #fff176;
            color: #f57f17;
        }

        .status-rep {
            background: #ffffff;
            color: #000000;
            border: 1px solid #000000;
        }

        /* Styles pour diff√©rencier les colonnes Match et Entra√Ænement */
        .match-session {
            background-color: #f0f8ff !important;
        }
        
        .match-session select {
            background-color: #e6f2ff;
        }
        
        .match-header {
            background-color: #4a86e8 !important;
            color: white !important;
        }
        
        body.contrasted-theme .match-session {
            background-color: #e0e0e0 !important;
            border: 2px solid #666 !important;
        }
        
        body.contrasted-theme .match-session select {
            background-color: #d0d0d0 !important;
        }
        
        body.contrasted-theme .match-header {
            background-color: #666 !important;
            color: white !important;
            border: 2px solid #333 !important;
        }
        
        /* Styles sp√©cifiques pour les matchs */
        .match-session .status-pst {
            background: #4caf50;
            color: white;
            border: 2px solid #2e7d32;
        }
        
        .match-session .status-ca {
            background: #0d47a1;
            color: white;
            border: 2px solid #001970;
        }
        
        .match-session .status-cb {
            background: #1976d2;
            color: white;
            border: 2px solid #0d47a1;
        }
        
        .match-session .status-cc {
            background: #42a5f5;
            color: white;
            border: 2px solid #1976d2;
        }
        
        /* Styles pour les options du menu d√©roulant */
        option.opt-abp { background-color: #ffcdd2; color: #d32f2f; }
        option.opt-absp { background-color: #d32f2f; color: white; }
        option.opt-bls { background-color: #ffcc80; color: #f57c00; }
        option.opt-vac { background-color: #f8bbd9; color: #c2185b; }
        option.opt-pst { background-color: #c8e6c9; color: #2e7d32; }
        option.opt-ca { background-color: #1976d2; color: white; }
        option.opt-cb { background-color: #42a5f5; color: white; }
        option.opt-cc { background-color: #90caf9; color: #1976d2; }
        option.opt-ret { background-color: #fff176; color: #f57f17; }
        option.opt-rep { background-color: #ffffff; color: #000000; }

        .ranking-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .ranking-table th {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px;
            font-weight: 600;
            text-align: left;
        }

        .ranking-table td {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }

        .ranking-table tr:hover td {
            background: #f8f9ff;
        }

        .rank-medal {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            font-weight: bold;
        }

        .rank-1 { color: #FFD700; }
        .rank-2 { color: #C0C0C0; }
        .rank-3 { color: #CD7F32; }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 5px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            transition: width 0.3s ease;
        }

        .badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin: 0 5px;
        }

        .badge-gold {
            background: #FFD700;
            color: #333;
        }

        .badge-silver {
            background: #C0C0C0;
            color: #333;
        }

        .badge-bronze {
            background: #CD7F32;
            color: white;
        }

        .badge-assidu {
            background: #28a745;
            color: white;
        }

        .badge-regulier {
            background: #007bff;
            color: white;
        }
        
        .badge-ponctuel {
            background: #17a2b8;
            color: white;
        }
        
        .badge-parfait {
            background: #28a745;
            color: white;
        }

        .badge-warning {
            background: #ffc107;
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.2);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 40px;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: modalFadeIn 0.3s ease-out;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover {
            color: #000;
        }

        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin: 30px 0;
        }

        .chart-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .chart-title {
            font-size: 1.4em;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
            text-align: center;
        }

        /* ===== OPTIMISATION MOBILE COMPL√àTE ===== */
        @media (max-width: 768px) {
            /* Container et padding globaux */
            .container {
                padding: 8px;
                margin: 0;
            }

            /* Header optimis√© */
            .header {
                padding: 15px 8px;
                text-align: center;
            }

            .header h1 {
                font-size: 1.8em;
                margin: 0;
            }

            .firebase-status {
                font-size: 0.8em;
                margin-top: 8px;
            }

            /* Navigation tactile am√©lior√©e */
            .nav-tabs {
                flex-direction: row;
                justify-content: space-around;
                padding: 8px;
                margin: 0 -8px;
                background: #f8f9fa;
                overflow-x: auto;
                white-space: nowrap;
                -webkit-overflow-scrolling: touch;
            }

            .tab-button {
                min-width: 80px;
                padding: 12px 8px;
                font-size: 0.9em;
                border-radius: 8px;
                margin: 0 2px;
                flex-shrink: 0;
            }

            /* Grilles responsive */
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
                margin: 15px 0;
            }

            .stat-card {
                padding: 15px 10px;
                border-radius: 8px;
            }

            .stat-number {
                font-size: 1.5em;
            }

            .stat-label {
                font-size: 0.8em;
            }

            .charts-container {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            /* Section headers mobiles */
            .section-header {
                padding: 15px 8px;
            }

            .section-title {
                font-size: 1.3em;
                margin-bottom: 12px;
            }

            /* Boutons adapt√©s au tactile */
            .btn-group {
                display: flex;
                flex-wrap: wrap;
                gap: 8px;
                justify-content: center;
            }

            .btn {
                padding: 12px 16px;
                font-size: 0.9em;
                border-radius: 8px;
                min-width: 140px;
                text-align: center;
                flex: 1 1 calc(50% - 4px);
                max-width: calc(50% - 4px);
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            /* ===== INTERFACE MOBILE CARDS R√âVOLUTIONNAIRE ===== */
            .mobile-presence-container {
                display: none; /* Masqu√© par d√©faut, affich√© seulement sur mobile */
                padding: 10px 8px;
            }
            
            /* Afficher les cards seulement sur mobile */
            .mobile-presence-container.active {
                display: block;
            }
            
            /* Masquer le tableau sur mobile quand les cards sont actives */
            .presence-table-container.mobile-hidden {
                display: none !important;
            }

            /* S√©lecteur de session mobile */
            .mobile-session-selector {
                background: white;
                border-radius: 12px;
                padding: 15px;
                margin-bottom: 15px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            }

            .mobile-session-selector h3 {
                margin: 0 0 12px 0;
                font-size: 1.1em;
                color: #2c3e50;
                text-align: center;
            }

            .session-buttons {
                display: flex;
                gap: 8px;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                padding: 5px 0;
            }

            .session-btn {
                flex: 0 0 auto;
                padding: 12px 16px;
                background: #f8f9fa;
                border: 2px solid #e9ecef;
                border-radius: 8px;
                font-size: 0.9em;
                font-weight: 600;
                text-align: center;
                cursor: pointer;
                transition: all 0.2s;
                white-space: nowrap;
                min-width: 100px;
            }

            .session-btn.active {
                background: #007bff;
                color: white;
                border-color: #0056b3;
                transform: scale(1.05);
            }

            .session-btn .session-date {
                display: block;
                font-size: 0.8em;
                opacity: 0.8;
            }

            .session-btn .session-type {
                display: block;
                font-size: 0.7em;
                margin-top: 2px;
            }

            /* Cards des joueurs */
            .mobile-players-list {
                display: flex;
                flex-direction: column;
                gap: 12px;
            }

            .mobile-player-card {
                background: white;
                border-radius: 12px;
                padding: 16px;
                box-shadow: 0 2px 12px rgba(0,0,0,0.08);
                border: 2px solid transparent;
                transition: all 0.3s ease;
                position: relative;
                overflow: hidden;
                user-select: none;
                -webkit-user-select: none;
                touch-action: pan-y;
            }
            
            /* √âtats de swipe */
            .mobile-player-card.swipe-left {
                transform: translateX(-20px);
                background: linear-gradient(90deg, #fff 0%, #ffebee 100%);
                border-color: #f44336;
            }
            
            .mobile-player-card.swipe-right {
                transform: translateX(20px);
                background: linear-gradient(90deg, #fff 0%, #e8f5e8 100%);
                border-color: #4caf50;
            }
            
            .mobile-player-card.swipe-up {
                transform: translateY(-10px);
                background: linear-gradient(180deg, #fff 0%, #f5f5f5 100%);
                border-color: #9e9e9e;
            }
            
            .mobile-player-card.swipe-down {
                transform: translateY(10px);
                background: linear-gradient(180deg, #fff 0%, #e3f2fd 100%);
                border-color: #2196f3;
            }

            /* Indicateurs de swipe */
            .mobile-swipe-indicator {
                position: absolute;
                font-size: 2em;
                font-weight: bold;
                opacity: 0;
                transition: all 0.2s ease;
                pointer-events: none;
                text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            }
            
            .mobile-swipe-indicator.left {
                left: 20px;
                top: 50%;
                transform: translateY(-50%);
                color: #f44336;
            }
            
            .mobile-swipe-indicator.right {
                right: 20px;
                top: 50%;
                transform: translateY(-50%);
                color: #4caf50;
            }
            
            .mobile-swipe-indicator.up {
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                color: #9e9e9e;
            }
            
            .mobile-swipe-indicator.down {
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                color: #2196f3;
            }
            
            .mobile-swipe-indicator.show {
                opacity: 1;
            }

            .mobile-player-card.status-pst { border-color: #28a745; background: #f8fff9; }
            .mobile-player-card.status-abp { border-color: #ffc107; background: #fffef8; }
            .mobile-player-card.status-absp { border-color: #dc3545; background: #fff8f8; }
            .mobile-player-card.status-bls { border-color: #fd7e14; background: #fff9f5; }
            .mobile-player-card.status-vac { border-color: #17a2b8; background: #f8fcfd; }
            .mobile-player-card.status-rep { border-color: #6c757d; background: #f8f9fa; }
            .mobile-player-card.status-ca { border-color: #28a745; background: #f0fff4; }
            .mobile-player-card.status-cb { border-color: #28a745; background: #f0fff4; }
            .mobile-player-card.status-cc { border-color: #28a745; background: #f0fff4; }
            .mobile-player-card.status-ret { border-color: #ffc107; background: #fffdf0; }

            .mobile-player-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 15px;
            }

            .mobile-player-name {
                font-size: 1.1em;
                font-weight: 700;
                color: #2c3e50;
            }

            .mobile-current-status {
                padding: 6px 12px;
                border-radius: 20px;
                font-size: 0.8em;
                font-weight: 600;
                color: white;
                text-shadow: 0 1px 2px rgba(0,0,0,0.2);
            }

            /* Grille de boutons de statut */
            .mobile-status-grid {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
                margin-top: 5px;
            }

            .mobile-status-btn {
                padding: 12px 8px;
                border: 2px solid transparent;
                border-radius: 8px;
                font-size: 0.85em;
                font-weight: 600;
                text-align: center;
                cursor: pointer;
                transition: all 0.2s ease;
                position: relative;
                overflow: hidden;
            }

            .mobile-status-btn:active {
                transform: scale(0.95);
            }

            .mobile-status-btn.selected {
                transform: scale(1.05);
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 2;
            }

            /* Couleurs des boutons de statut */
            .mobile-status-btn.btn-pst { background: #28a745; color: white; }
            .mobile-status-btn.btn-abp { background: #ffc107; color: #333; }
            .mobile-status-btn.btn-absp { background: #dc3545; color: white; }
            .mobile-status-btn.btn-bls { background: #fd7e14; color: white; }
            .mobile-status-btn.btn-vac { background: #17a2b8; color: white; }
            .mobile-status-btn.btn-rep { background: #6c757d; color: white; }
            .mobile-status-btn.btn-ca { background: #20c997; color: white; }
            .mobile-status-btn.btn-cb { background: #20c997; color: white; }
            .mobile-status-btn.btn-cc { background: #20c997; color: white; }
            .mobile-status-btn.btn-ret { background: #e83e8c; color: white; }

            .mobile-status-btn.btn-pst.selected { box-shadow: 0 0 0 3px rgba(40,167,69,0.3); }
            .mobile-status-btn.btn-abp.selected { box-shadow: 0 0 0 3px rgba(255,193,7,0.3); }
            .mobile-status-btn.btn-absp.selected { box-shadow: 0 0 0 3px rgba(220,53,69,0.3); }
            .mobile-status-btn.btn-bls.selected { box-shadow: 0 0 0 3px rgba(253,126,20,0.3); }
            .mobile-status-btn.btn-vac.selected { box-shadow: 0 0 0 3px rgba(23,162,184,0.3); }
            .mobile-status-btn.btn-rep.selected { box-shadow: 0 0 0 3px rgba(108,117,125,0.3); }
            .mobile-status-btn.btn-ca.selected { box-shadow: 0 0 0 3px rgba(32,201,151,0.3); }
            .mobile-status-btn.btn-cb.selected { box-shadow: 0 0 0 3px rgba(32,201,151,0.3); }
            .mobile-status-btn.btn-cc.selected { box-shadow: 0 0 0 3px rgba(32,201,151,0.3); }
            .mobile-status-btn.btn-ret.selected { box-shadow: 0 0 0 3px rgba(232,62,140,0.3); }

            /* Toggle pour passer entre vue tableau et vue cards */
            .mobile-view-toggle {
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: #007bff;
                color: white;
                border: none;
                border-radius: 50%;
                width: 56px;
                height: 56px;
                font-size: 1.2em;
                cursor: pointer;
                box-shadow: 0 4px 16px rgba(0,123,255,0.4);
                z-index: 1000;
                transition: all 0.3s ease;
            }

            .mobile-view-toggle:active {
                transform: scale(0.9);
            }

            .mobile-view-toggle.cards-active {
                background: #28a745;
            }

            /* Animation de feedback */
            .mobile-status-feedback {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(255,255,255,0.9);
                border-radius: 50%;
                width: 30px;
                height: 30px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 1.2em;
                opacity: 0;
                animation: statusFeedback 0.6s ease-out;
            }

            @keyframes statusFeedback {
                0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
                50% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
                100% { opacity: 0; transform: translate(-50%, -50%) scale(1); }
            }

            /* Indicateur de session */
            .mobile-session-indicator {
                text-align: center;
                padding: 10px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border-radius: 8px;
                margin-bottom: 15px;
                font-weight: 600;
            }

            /* Recherche mobile am√©lior√©e */
            .mobile-search {
                background: white;
                border-radius: 12px;
                padding: 12px;
                margin-bottom: 15px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            }

            .mobile-search input {
                width: 100%;
                padding: 12px 16px;
                border: 2px solid #e9ecef;
                border-radius: 25px;
                font-size: 1em;
                background: #f8f9fa;
                transition: all 0.2s;
            }

            .mobile-search input:focus {
                border-color: #007bff;
                background: white;
                box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
            }

            /* S√©lecteur de tri mobile */
            .sort-container {
                margin: 10px 0;
                text-align: center;
            }

            .sort-container select {
                padding: 10px 15px;
                font-size: 1em;
                border-radius: 8px;
                border: 2px solid #dee2e6;
                background: white;
                width: 100%;
                max-width: 250px;
            }

            /* Modals mobiles */
            .modal {
                padding: 10px;
                margin: 0;
                width: 100vw;
                height: 100vh;
                position: fixed;
                top: 0;
                left: 0;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }

            .modal-content {
                width: 100%;
                max-width: none;
                margin: 20px 0;
                padding: 20px 15px;
                border-radius: 12px;
                max-height: calc(100vh - 40px);
                overflow-y: auto;
            }

            .modal h2 {
                font-size: 1.4em;
                margin-bottom: 15px;
                text-align: center;
                color: #2c3e50;
            }

            .modal .form-group {
                margin-bottom: 15px;
            }

            .modal .form-group label {
                display: block;
                margin-bottom: 6px;
                font-weight: 600;
                color: #34495e;
            }

            .modal input,
            .modal select {
                width: 100%;
                padding: 12px;
                font-size: 1em;
                border: 2px solid #e9ecef;
                border-radius: 8px;
                box-sizing: border-box;
            }

            .modal input:focus,
            .modal select:focus {
                border-color: #007bff;
                outline: none;
                box-shadow: 0 0 0 3px rgba(0,123,255,0.25);
            }

            .modal .btn {
                width: 100%;
                margin: 10px 0 5px 0;
                padding: 15px;
                font-size: 1.1em;
                font-weight: 600;
            }

            /* Tableaux dans les modals */
            .modal table {
                width: 100%;
                font-size: 0.9em;
                display: block;
                overflow-x: auto;
                white-space: nowrap;
                -webkit-overflow-scrolling: touch;
            }

            .modal th,
            .modal td {
                padding: 8px;
                min-width: 80px;
            }

            /* Graphiques mobiles */
            .chart-container {
                position: relative;
                height: 250px;
                margin: 15px 0;
            }

            /* L√©gende mobile */
            .legend {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
                margin: 15px 0;
                font-size: 0.8em;
            }

            .legend-item {
                display: flex;
                align-items: center;
                padding: 8px;
                background: #f8f9fa;
                border-radius: 6px;
            }

            /* Indicateurs visuels am√©lior√©s */
            .badge {
                font-size: 0.7em;
                padding: 4px 6px;
                border-radius: 4px;
                display: inline-block;
                margin: 2px;
            }

            /* Th√®me sombre mobile */
            .contrasted-theme .container {
                background: #1a1a1a;
            }

            .contrasted-theme .presence-table th:first-child,
            .contrasted-theme .presence-table td:first-child {
                background: #2c2c2c;
                color: white;
            }

            .contrasted-theme .modal-content {
                background: #2c2c2c;
                color: white;
            }

            /* Animations tactiles */
            .btn:active {
                transform: scale(0.95);
            }

            .presence-cell:active {
                transform: scale(0.9);
            }

            /* Scroll indicators */
            .presence-table-container::after {
                content: '‚Üê Faites glisser ‚Üí';
                position: absolute;
                bottom: 5px;
                right: 10px;
                font-size: 0.7em;
                color: #6c757d;
                pointer-events: none;
            }
        }

        /* Petits mobiles (< 480px) */
        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.5em;
            }

            .tab-button {
                font-size: 0.8em;
                padding: 10px 6px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .btn {
                flex: 1 1 100%;
                max-width: 100%;
                margin: 4px 0;
            }

            .presence-cell {
                width: 45px;
                font-size: 8px;
            }

            .presence-table th:first-child,
            .presence-table td:first-child {
                min-width: 70px;
                max-width: 70px;
            }
        }

        /* Mode paysage mobile */
        @media (max-height: 500px) and (orientation: landscape) {
            .modal-content {
                margin: 10px 0;
                padding: 15px;
            }
            
            .header {
                padding: 10px 8px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        /* Th√®me contrast√© */
        body.contrasted-theme {
            background: #f8f9fa !important;
            color: #000 !important;
        }

        body.contrasted-theme .header {
            background: #fff !important;
            color: #000 !important;
            border: 2px solid #333;
        }

        body.contrasted-theme .header h1 {
            color: #000 !important;
            text-shadow: none !important;
        }

        body.contrasted-theme .header p {
            color: #333 !important;
        }

        body.contrasted-theme .tab-button {
            background: #fff !important;
            color: #000 !important;
            border: 2px solid #333 !important;
        }

        body.contrasted-theme .tab-button.active {
            background: #000 !important;
            color: #fff !important;
        }

        body.contrasted-theme .tab-content {
            background: #fff !important;
            color: #000 !important;
            border: 2px solid #333;
        }

        body.contrasted-theme .presence-table {
            background: #fff !important;
            color: #000 !important;
        }

        body.contrasted-theme .presence-table th {
            background: #f8f9fa !important;
            color: #000 !important;
            border: 1px solid #333 !important;
        }

        body.contrasted-theme .presence-table td {
            background: #fff !important;
            color: #000 !important;
            border: 1px solid #333 !important;
        }

        body.contrasted-theme .status-cell {
            color: #000 !important;
            font-weight: bold !important;
        }

        body.contrasted-theme .btn-primary {
            background: #fff !important;
            color: #000 !important;
            border: 2px solid #333 !important;
        }

        body.contrasted-theme .btn-secondary {
            background: #f8f9fa !important;
            color: #000 !important;
            border: 2px solid #666 !important;
        }

        body.contrasted-theme .modal-content {
            background: #fff !important;
            color: #000 !important;
            border: 2px solid #333 !important;
        }

        body.contrasted-theme #themeToggle {
            background: #000 !important;
            color: #fff !important;
            border: 2px solid #333 !important;
        }

        body.contrasted-theme #themeToggle:hover {
            background: #333 !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚öΩ Senior</h1>
            <p>Syst√®me de Gestion des Pr√©sences</p>
            <div id="firebaseStatus" style="margin-top: 10px; font-size: 14px; opacity: 0.8;">
                <span id="statusIndicator">üîÑ</span> <span id="statusText">Connexion Firebase...</span>
                <button id="retryFirebase" style="margin-left: 10px; padding: 2px 8px; font-size: 12px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; display: none;" onclick="retryFirebaseConnection()">üîÑ Retry</button>
            </div>
            <div style="margin-top: 15px;">
                <button id="themeToggle" onclick="toggleTheme()" style="padding: 8px 16px; background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 20px; cursor: pointer; font-size: 14px; transition: all 0.3s ease;">
                    üåì Th√®me Contrast√©
                </button>
            </div>
        </div>

        <div class="nav-tabs">
            <button class="tab-button active" onclick="showTab('presence')">üìä Tableau de Bord</button>
            <button class="tab-button" onclick="showTab('total')">üèÜ Total Pr√©sences</button>
            <button class="tab-button" onclick="showTab('competition')">üéØ Comp√©tition</button>
        </div>

        <!-- Onglet Pr√©sences Individuelles -->
        <div id="presence" class="tab-content active">
            <div class="section-header">
                <h2 class="section-title">Gestion des Pr√©sences</h2>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="showManagePlayersModal()">üë• G√©rer Joueurs</button>
                    <button class="btn btn-secondary" onclick="showManageDatesModal()">üìÖ G√©rer Dates</button>
                    <button class="btn btn-warning" onclick="showManagePeriodsModal()">‚è±Ô∏è G√©rer P√©riodes</button>
                    <button class="btn btn-danger" onclick="showScheduledAbsencesModal()">üóìÔ∏è Statuts Programm√©s</button>
                    <button class="btn btn-info" onclick="showExportPDFModal()">üìä Export PDF Personnalis√©</button>
                    <button class="btn btn-success" onclick="saveData()" id="saveBtn">üíæ Sauvegarder</button>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalPlayers">0</div>
                    <div class="stat-label">Joueurs</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalSessions">0</div>
                    <div class="stat-label">Sessions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="avgAttendance">0%</div>
                    <div class="stat-label">Pr√©sence Moyenne</div>
                </div>
            </div>

            <div class="btn-group" style="margin-bottom: 20px;" id="periodButtons">
                <!-- Les boutons seront g√©n√©r√©s dynamiquement -->
            </div>

            <!-- Lexique -->
            <div style="background: #f8f9ff; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <h3 style="margin-bottom: 15px; color: #333;">üìö Lexique des Statuts</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span class="status-abp" style="padding: 4px 8px; border-radius: 4px; font-weight: 600; font-size: 12px;">AbP</span>
                        <span>Absent pr√©venu</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span class="status-absp" style="padding: 4px 8px; border-radius: 4px; font-weight: 600; font-size: 12px;">AbSP</span>
                        <span>Absent sans pr√©venir</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span class="status-bls" style="padding: 4px 8px; border-radius: 4px; font-weight: 600; font-size: 12px;">BLS</span>
                        <span>Blessure</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span class="status-vac" style="padding: 4px 8px; border-radius: 4px; font-weight: 600; font-size: 12px;">VAC</span>
                        <span>Vacances</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span class="status-pst" style="padding: 4px 8px; border-radius: 4px; font-weight: 600; font-size: 12px;">PST</span>
                        <span>Pr√©sent</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span class="status-ca" style="padding: 4px 8px; border-radius: 4px; font-weight: 600; font-size: 12px;">Ca</span>
                        <span>Convoqu√© √©quipe A</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span class="status-cb" style="padding: 4px 8px; border-radius: 4px; font-weight: 600; font-size: 12px;">Cb</span>
                        <span>Convoqu√© √©quipe B</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span class="status-cc" style="padding: 4px 8px; border-radius: 4px; font-weight: 600; font-size: 12px;">Cc</span>
                        <span>Convoqu√© √©quipe C</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span class="status-ret" style="padding: 4px 8px; border-radius: 4px; font-weight: 600; font-size: 12px;">RET</span>
                        <span>Retard</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span class="status-rep" style="padding: 4px 8px; border-radius: 4px; font-weight: 600; font-size: 12px;">REP</span>
                        <span>Repos</span>
                    </div>
                </div>
            </div>
            
            <!-- Barre de recherche et filtres -->
            <div style="background: #f8f9ff; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="searchInput">üîç Rechercher un joueur (pr√©nom/nom):</label>
                        <input type="text" id="searchInput" placeholder="Ex: Lucas, Martin..." style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px;" onkeyup="performSearch()">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="sortSelect">üìã Trier par:</label>
                        <select id="sortSelect" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px;" onchange="sortPlayers()">
                            <option value="default">Ordre par d√©faut</option>
                            <option value="alphabetical-prenom" selected>Ordre alphab√©tique (pr√©nom)</option>
                            <option value="alphabetical-nom">Ordre alphab√©tique (nom)</option>
                            <option value="recent">Plus r√©cent au plus ancien</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Vue tableau classique (desktop) -->
            <div class="presence-grid" id="desktopTableContainer">
                <table class="presence-table" id="presenceTable">
                    <thead>
                        <tr id="headerRow">
                            <th>Pr√©nom</th>
                            <th>Nom</th>
                        </tr>
                    </thead>
                    <tbody id="presenceBody">
                    </tbody>
                </table>
            </div>

            <!-- Vue mobile cards r√©volutionnaire -->
            <div class="mobile-presence-container" id="mobilePresenceContainer">
                <!-- Recherche mobile -->
                <div class="mobile-search">
                    <input type="text" placeholder="üîç Rechercher un joueur..." id="mobileSearchInput" oninput="filterMobilePlayers()">
                </div>

                <!-- S√©lecteur de session -->
                <div class="mobile-session-selector">
                    <h3>üìÖ Choisir une session</h3>
                    <div class="session-buttons" id="mobileSessionButtons">
                        <!-- Sessions g√©n√©r√©es dynamiquement -->
                    </div>
                </div>

                <!-- Indicateur de session actuelle -->
                <div class="mobile-session-indicator" id="currentSessionIndicator">
                    S√©lectionnez une session pour commencer
                </div>

                <!-- Liste des joueurs en cards -->
                <div class="mobile-players-list" id="mobilePlayersList">
                    <!-- Cards g√©n√©r√©es dynamiquement -->
                </div>

                <!-- Bouton toggle vue -->
                <button class="mobile-view-toggle" id="mobileViewToggle" onclick="toggleMobileView()" title="Basculer vers vue tableau">
                    üìä
                </button>
            </div>
        </div>

        <!-- Onglet Total Pr√©sences -->
        <div id="total" class="tab-content">
            <div class="section-header">
                <h2 class="section-title">Classement des Pr√©sences</h2>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="calculateTotals()">üîÑ Actualiser</button>
                    <button class="btn btn-success" onclick="exportRankingPDF()">üìÑ Export PDF</button>
                    <button class="btn btn-secondary" onclick="exportTop10PDF()">üèÜ Export Top 10</button>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="bestPlayer">-</div>
                    <div class="stat-label">Meilleur Joueur</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="bestRate">0%</div>
                    <div class="stat-label">Meilleur Taux</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalTrainings">0</div>
                    <div class="stat-label">Total Entra√Ænements</div>
                </div>
            </div>

            <div class="charts-container">
                <div class="chart-card">
                    <div class="chart-title">Top 10 des Pr√©sences</div>
                    <canvas id="top10Chart"></canvas>
                </div>
                <div class="chart-card">
                    <div class="chart-title">√âvolution Mensuelle</div>
                    <canvas id="evolutionChart"></canvas>
                </div>
            </div>

            <table class="ranking-table" id="rankingTable">
                <thead>
                    <tr>
                        <th>Rang</th>
                        <th>Pr√©nom</th>
                        <th>Nom</th>
                        <th>Pr√©sences</th>
                        <th>Taux</th>
                        <th>Points</th>
                        <th>Badges</th>
                    </tr>
                </thead>
                <tbody id="rankingBody">
                </tbody>
            </table>
        </div>

        <!-- Onglet Comp√©tition -->
        <div id="competition" class="tab-content">
            <div class="section-header">
                <h2 class="section-title">Syst√®me de Comp√©tition</h2>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="updateCompetition()">üîÑ Actualiser</button>
                    <button class="btn btn-success" onclick="exportCompetitionPDF()">üìÑ Export Comp√©tition</button>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="monthWinner">-</div>
                    <div class="stat-label">Meilleur Taux Assiduit√©</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="bestAttendanceRate">0%</div>
                    <div class="stat-label">Taux le Plus √âlev√©</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="averageAttendance">0%</div>
                    <div class="stat-label">Moyenne G√©n√©rale</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="perfectPlayers">0</div>
                    <div class="stat-label">Joueurs Sans Absence</div>
                </div>
            </div>

            <div class="charts-container">
                <div class="chart-card">
                    <div class="chart-title">Classement par Taux d'Assiduit√©</div>
                    <canvas id="pointsChart"></canvas>
                </div>
                <div class="chart-card">
                    <div class="chart-title">R√©partition des Statuts</div>
                    <canvas id="badgesChart"></canvas>
                </div>
            </div>

            <table class="ranking-table" id="competitionTable">
                <thead>
                    <tr>
                        <th>Rang</th>
                        <th>Pr√©nom</th>
                        <th>Nom</th>
                        <th>Taux Assiduit√©</th>
                        <th>Pr√©sences</th>
                        <th>Vacances/Cong√©s</th>
                        <th>Absences</th>
                        <th>Retards</th>
                        <th>Badges</th>
                    </tr>
                </thead>
                <tbody id="competitionBody">
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <div id="modalContent"></div>
        </div>
    </div>

    <script>
        // Variables globales
        let players = [];
        let sessions = [];
        let presences = {};
        let scheduledAbsences = []; // Nouvelle variable pour les absences programm√©es
        let currentPeriod = 'all';
        let currentSort = 'alphabetical-prenom';
        let isFirebaseInitialized = false;
        let unsubscribeListeners = [];
        let isContrastedTheme = false;

        // Fonction pour vider TOUTES les sessions de TOUTES les saisons
        function clearAllSessions() {
            console.log('üóëÔ∏è Suppression compl√®te de toutes les sessions...');
            
            // Vider le tableau des sessions en m√©moire
            sessions = [];
            
            // Vider toutes les pr√©sences de tous les joueurs
            players.forEach(player => {
                presences[player.id] = {};
            });
            
            // Supprimer du localStorage
            localStorage.removeItem('senior2526Data');
            localStorage.removeItem('seniorData'); // Au cas o√π l'ancien nom serait utilis√©
            
            // Sauvegarder l'√©tat vide (√©crase Firebase aussi)
            saveData();
            
            // Si Firebase est initialis√©, supprimer aussi de Firebase
            if (isFirebaseInitialized && window.db && window.firebaseServices) {
                try {
                    // Nettoyer Firebase en sauvegardant un √©tat vide
                    const emptyData = {
                        players: players,
                        sessions: [], // Vide
                        presences: presences,
                        customPeriods: customPeriods,
                        lastUpdated: new Date().toISOString()
                    };
                    
                    const { doc, setDoc } = window.firebaseServices;
                    setDoc(doc(window.db, 'seniorData', 'main'), emptyData)
                        .then(() => console.log('‚úÖ Sessions supprim√©es de Firebase'))
                        .catch(error => console.log('‚ö†Ô∏è Erreur Firebase:', error));
                } catch (error) {
                    console.log('‚ö†Ô∏è Erreur lors du nettoyage Firebase:', error);
                }
            }
            
            console.log('‚úÖ Toutes les sessions ont √©t√© supprim√©es de tous les stockages');
        }
        let customPeriods = [
            { id: 'all', name: 'Toute la saison', startDate: null, endDate: null },
            
            // Saison compl√®te 2025-2026 (ao√ªt 2025 √† juin 2026)
            {
                id: 'season2025',
                name: 'Saison 2025-2026',
                startDate: '2025-08-01',
                endDate: '2026-06-30'
            },
            
            // Trimestres selon votre demande
            {
                id: 'q1_2025',
                name: 'T1: Sept-Oct-Nov 2025',
                startDate: '2025-09-01',
                endDate: '2025-11-30'
            },
            {
                id: 'q2_2025',
                name: 'T2: D√©c-Jan-F√©v 2025-26',
                startDate: '2025-12-01',
                endDate: '2026-02-28'
            },
            {
                id: 'q3_2026',
                name: 'T3: Mars-Avr-Mai 2026',
                startDate: '2026-03-01',
                endDate: '2026-05-31'
            },
            {
                id: 'q4_2026',
                name: 'T4: Juin 2026',
                startDate: '2026-06-01',
                endDate: '2026-06-30'
            },
            
            // Mois individuels (ao√ªt 2025 √† juin 2026)
            { id: 'aug2025', name: 'Ao√ªt 2025', startDate: '2025-08-01', endDate: '2025-08-31' },
            { id: 'sep2025', name: 'Septembre 2025', startDate: '2025-09-01', endDate: '2025-09-30' },
            { id: 'oct2025', name: 'Octobre 2025', startDate: '2025-10-01', endDate: '2025-10-31' },
            { id: 'nov2025', name: 'Novembre 2025', startDate: '2025-11-01', endDate: '2025-11-30' },
            { id: 'dec2025', name: 'D√©cembre 2025', startDate: '2025-12-01', endDate: '2025-12-31' },
            { id: 'jan2026', name: 'Janvier 2026', startDate: '2026-01-01', endDate: '2026-01-31' },
            { id: 'feb2026', name: 'F√©vrier 2026', startDate: '2026-02-01', endDate: '2026-02-28' },
            { id: 'mar2026', name: 'Mars 2026', startDate: '2026-03-01', endDate: '2026-03-31' },
            { id: 'apr2026', name: 'Avril 2026', startDate: '2026-04-01', endDate: '2026-04-30' },
            { id: 'may2026', name: 'Mai 2026', startDate: '2026-05-01', endDate: '2026-05-31' },
            { id: 'jun2026', name: 'Juin 2026', startDate: '2026-06-01', endDate: '2026-06-30' }
        ];

        // Fonction pour r√©essayer la connexion Firebase
        async function retryFirebaseConnection() {
            console.log('üîÑ Tentative de reconnexion Firebase manuelle...');
            updateFirebaseStatus('üîÑ', 'Reconnexion en cours...', '#ffc107');
            
            // Cacher le bouton retry pendant la tentative
            const retryBtn = document.getElementById('retryFirebase');
            if (retryBtn) retryBtn.style.display = 'none';
            
            try {
                // R√©initialiser les variables
                isFirebaseInitialized = false;
                
                // R√©essayer l'initialisation compl√®te
                await initializeFirebase();
                
            } catch (error) {
                console.error('‚ùå √âchec de la reconnexion manuelle:', error);
                updateFirebaseStatus('‚ùå', 'Reconnexion √©chou√©e - Mode local', '#dc3545');
                
                // Remettre le bouton retry
                if (retryBtn) retryBtn.style.display = 'inline-block';
                
                // Fallback sur localStorage
                loadData();
                initializeData();
                updateStats();
                updatePeriodButtons();
                renderPresenceTable();
            }
        }

        // Fonction de toggle du th√®me contrast√©
        function toggleTheme() {
            isContrastedTheme = !isContrastedTheme;
            const body = document.body;
            const themeButton = document.getElementById('themeToggle');
            
            if (isContrastedTheme) {
                body.classList.add('contrasted-theme');
                themeButton.innerHTML = 'üåû Th√®me Normal';
                localStorage.setItem('contrastedTheme', 'true');
            } else {
                body.classList.remove('contrasted-theme');
                themeButton.innerHTML = 'üåì Th√®me Contrast√©';
                localStorage.setItem('contrastedTheme', 'false');
            }
        }

        // Charger la pr√©f√©rence de th√®me au d√©marrage
        function loadThemePreference() {
            const savedTheme = localStorage.getItem('contrastedTheme');
            if (savedTheme === 'true') {
                isContrastedTheme = true;
                document.body.classList.add('contrasted-theme');
                document.getElementById('themeToggle').innerHTML = 'üåû Th√®me Normal';
            }
        }

        // D√©tection mobile et optimisations
        function isMobileDevice() {
            return window.innerWidth <= 768 || /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }

        // Am√©liorations tactiles pour mobile
        function enhanceMobileExperience() {
            if (isMobileDevice()) {
                // Ajouter des √©v√©nements tactiles am√©lior√©s
                document.addEventListener('touchstart', function() {}, {passive: true});
                
                // Optimiser les scrolls
                const tableContainer = document.querySelector('.presence-table-container');
                if (tableContainer) {
                    tableContainer.style.webkitOverflowScrolling = 'touch';
                }
                
                // Am√©liorer les focus pour mobile
                const inputs = document.querySelectorAll('input, select, button');
                inputs.forEach(input => {
                    input.addEventListener('focus', function() {
                        this.scrollIntoView({behavior: 'smooth', block: 'center'});
                    });
                });

                // Gesture swipe pour navigation entre onglets
                let startX = null;
                document.addEventListener('touchstart', function(e) {
                    startX = e.touches[0].clientX;
                });

                document.addEventListener('touchmove', function(e) {
                    if (!startX) return;
                    
                    const currentX = e.touches[0].clientX;
                    const diff = startX - currentX;
                    
                    // Swipe horizontal pour changer d'onglet (seulement si pas dans un input)
                    if (Math.abs(diff) > 50 && !e.target.closest('input, select, .presence-table')) {
                        if (diff > 0) {
                            // Swipe gauche - onglet suivant
                            const tabs = document.querySelectorAll('.tab-button');
                            const activeTab = document.querySelector('.tab-button.active');
                            if (activeTab) {
                                const currentIndex = Array.from(tabs).indexOf(activeTab);
                                if (currentIndex < tabs.length - 1) {
                                    tabs[currentIndex + 1].click();
                                }
                            }
                        } else {
                            // Swipe droite - onglet pr√©c√©dent  
                            const tabs = document.querySelectorAll('.tab-button');
                            const activeTab = document.querySelector('.tab-button.active');
                            if (activeTab) {
                                const currentIndex = Array.from(tabs).indexOf(activeTab);
                                if (currentIndex > 0) {
                                    tabs[currentIndex - 1].click();
                                }
                            }
                        }
                        startX = null;
                    }
                });

                document.addEventListener('touchend', function() {
                    startX = null;
                });
            }
        }

        // Optimisation du tableau de pr√©sences pour mobile
        function optimizeTableForMobile() {
            if (isMobileDevice()) {
                const table = document.querySelector('.presence-table');
                if (table) {
                    // Ajouter indicateur de scroll
                    const container = table.closest('.presence-table-container') || table.parentElement;
                    if (container && !container.querySelector('.scroll-hint')) {
                        const hint = document.createElement('div');
                        hint.className = 'scroll-hint';
                        hint.innerHTML = 'üëÜ Glissez horizontalement pour voir toutes les dates';
                        hint.style.cssText = `
                            position: sticky;
                            bottom: 0;
                            background: rgba(0,0,0,0.7);
                            color: white;
                            text-align: center;
                            padding: 8px;
                            font-size: 0.8em;
                            z-index: 100;
                            border-radius: 6px;
                            margin: 5px;
                        `;
                        container.appendChild(hint);
                        
                        // Masquer l'indicateur apr√®s utilisation
                        container.addEventListener('scroll', function() {
                            if (this.scrollLeft > 20) {
                                hint.style.opacity = '0';
                                setTimeout(() => hint.remove(), 1000);
                            }
                        }, {once: true});
                    }

                    // Haptic feedback sur iOS
                    if (window.navigator.vibrate) {
                        const cells = table.querySelectorAll('.presence-cell');
                        cells.forEach(cell => {
                            cell.addEventListener('change', function() {
                                navigator.vibrate(50); // Feedback tactile l√©ger
                            });
                        });
                    }
                }
            }
        }

        // Am√©lioration des modals pour mobile
        function improveMobileModals() {
            const originalShowModal = window.showModal;
            window.showModal = function(content) {
                originalShowModal(content);
                
                if (isMobileDevice()) {
                    const modal = document.querySelector('.modal');
                    if (modal) {
                        // Emp√™cher le scroll du body
                        document.body.style.overflow = 'hidden';
                        
                        // Am√©liorer le focus
                        const firstInput = modal.querySelector('input, select, button');
                        if (firstInput) {
                            setTimeout(() => firstInput.focus(), 100);
                        }
                        
                        // Fermeture avec swipe down
                        let startY = null;
                        modal.addEventListener('touchstart', function(e) {
                            startY = e.touches[0].clientY;
                        });
                        
                        modal.addEventListener('touchmove', function(e) {
                            if (!startY) return;
                            const currentY = e.touches[0].clientY;
                            const diff = currentY - startY;
                            
                            // Swipe vers le bas pour fermer
                            if (diff > 100 && e.target === modal) {
                                closeModal();
                            }
                        });
                    }
                }
            };
            
            const originalCloseModal = window.closeModal;
            window.closeModal = function() {
                if (isMobileDevice()) {
                    document.body.style.overflow = ''; // Restaurer le scroll
                }
                originalCloseModal();
            };
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            // Charger les pr√©f√©rences
            loadThemePreference();
            
            // D√©finir la p√©riode par d√©faut sur la saison 2025-2026
            currentPeriod = 'season2025';
            
            // Optimisations mobiles
            enhanceMobileExperience();
            improveMobileModals();
            
            // Initialiser la vue mobile si sur mobile
            if (isMobileDevice()) {
                setTimeout(() => {
                    initializeMobileView();
                }, 500);
            }
            
            // Tentative d'initialisation Firebase avec retry
            let attempts = 0;
            const maxAttempts = 10;
            const checkFirebase = () => {
                attempts++;
                if (window.firebaseServices) {
                    console.log(`‚úÖ Firebase d√©tect√© apr√®s ${attempts} tentatives`);
                    initializeFirebase();
                } else if (attempts < maxAttempts) {
                    console.log(`üîÑ Tentative Firebase ${attempts}/${maxAttempts}...`);
                    setTimeout(checkFirebase, 500); // V√©rifier toutes les 500ms
                } else {
                    console.error('‚ùå Firebase services non charg√©s apr√®s', maxAttempts, 'tentatives');
                    updateFirebaseStatus('‚ùå', 'Firebase indisponible - Mode local', '#dc3545');
                    // Fallback apr√®s tous les essais
                    loadData();
                    initializeData();
                    updateStats();
                    updatePeriodButtons();
                    renderPresenceTable();
                }
            };
            checkFirebase();
        });
        
        // Initialiser Firebase et charger les donn√©es
        async function initializeFirebase() {
            updateFirebaseStatus('üîÑ', 'Connexion Firebase...', '#ffc107');
            
            try {
                // V√©rifier que tous les services sont disponibles
                if (!window.auth || !window.db || !window.firebaseServices) {
                    throw new Error('Services Firebase non charg√©s');
                }
                
                const { signInAnonymously, onAuthStateChanged } = window.firebaseServices;
                
                console.log('üîÑ Tentative de connexion Firebase...');
                
                // Connexion anonyme avec retry et timeout √©tendu
                let authSuccess = false;
                for (let retry = 0; retry < 3 && !authSuccess; retry++) {
                    try {
                        console.log(`üîÑ Tentative d'authentification ${retry + 1}/3...`);
                        const authPromise = signInAnonymously(window.auth);
                        const timeoutPromise = new Promise((_, reject) => 
                            setTimeout(() => reject(new Error('Timeout authentification')), 15000)
                        );
                        
                        await Promise.race([authPromise, timeoutPromise]);
                        authSuccess = true;
                        console.log('üî• Firebase authentifi√© avec succ√®s');
                    } catch (authError) {
                        console.warn(`‚ö†Ô∏è √âchec tentative ${retry + 1}:`, authError.message);
                        if (retry === 2) throw authError; // Derni√®re tentative
                        await new Promise(resolve => setTimeout(resolve, 2000)); // Attendre 2s avant retry
                    }
                }
                
                // √âcouter les changements d'authentification
                onAuthStateChanged(window.auth, (user) => {
                    if (user) {
                        console.log('üë§ Utilisateur connect√©:', user.uid);
                        isFirebaseInitialized = true;
                        updateFirebaseStatus('üî•', 'Connect√© - Synchronisation active', '#28a745');
                        loadDataFromFirebase();
                        
                        // Mettre √† jour le bouton de sauvegarde
                        const saveBtn = document.getElementById('saveBtn');
                        if (saveBtn) {
                            saveBtn.innerHTML = 'üî• Sauvegarder (Firebase)';
                        }
                    } else {
                        console.log('Utilisateur d√©connect√©');
                        updateFirebaseStatus('‚ùå', 'D√©connect√© - Mode local', '#dc3545');
                        loadDataFallback();
                    }
                });
                
            } catch (error) {
                console.error('‚ùå Erreur Firebase d√©taill√©e:', error.message, error);
                
                let errorMessage = 'Mode hors ligne (localStorage)';
                if (error.message.includes('auth')) {
                    errorMessage = 'Erreur authentification - Mode local';
                } else if (error.message.includes('network')) {
                    errorMessage = 'Pas de connexion - Mode local';
                } else if (error.message.includes('charg√©s')) {
                    errorMessage = 'Firebase non charg√© - Mode local';
                }
                
                updateFirebaseStatus('‚ùå', errorMessage, '#dc3545');
                loadDataFallback();
            }
        }
        
        // Fonction fallback pour charger les donn√©es en mode local
        function loadDataFallback() {
            loadData();
            initializeData();
            updateStats();
            updatePeriodButtons();
            renderPresenceTable();
        }
        
        // Mettre √† jour le statut Firebase dans l'interface
        function updateFirebaseStatus(icon, text, color) {
            const statusIndicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            const retryBtn = document.getElementById('retryFirebase');
            
            if (statusIndicator && statusText) {
                statusIndicator.textContent = icon;
                statusText.textContent = text;
                statusText.style.color = color;
                
                // Afficher le bouton retry si erreur
                if (retryBtn) {
                    retryBtn.style.display = icon === '‚ùå' ? 'inline-block' : 'none';
                }
            }
        }
        
        // Cette fonction est maintenant d√©finie plus haut avec une version am√©lior√©e (lignes 1103-1133)

        // Fonction pour afficher les onglets
        function showTab(tabName) {
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            const buttons = document.querySelectorAll('.tab-button');
            buttons.forEach(button => button.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'total') {
                calculateTotals();
            } else if (tabName === 'competition') {
                updateCompetition();
            }
        }

        // Fonction pour afficher une p√©riode
        function showPeriod(period) {
            currentPeriod = period;
            renderPresenceTable();
            updatePeriodButtons();
        }

        // Mettre √† jour les boutons de p√©riode
        function updatePeriodButtons() {
            const buttonsContainer = document.getElementById('periodButtons');
            buttonsContainer.innerHTML = '';
            
            customPeriods.forEach(period => {
                const button = document.createElement('button');
                button.className = `btn ${currentPeriod === period.id ? 'btn-primary' : 'btn-secondary'}`;
                button.textContent = `üìÖ ${period.name}`;
                button.onclick = () => showPeriod(period.id);
                buttonsContainer.appendChild(button);
            });
        }

        // G√©rer les p√©riodes (ajout/modification/suppression)
        function showManagePeriodsModal() {
            let periodsHtml = `
                <h2>‚è±Ô∏è G√©rer les P√©riodes</h2>
                
                <div style="background: #f8f9ff; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3>‚ûï Ajouter une Nouvelle P√©riode</h3>
                    <form onsubmit="addPeriodFromModal(event)">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div class="form-group">
                                <label>Nom de la p√©riode:</label>
                                <input type="text" name="name" placeholder="Ex: Octobre 2024" required>
                            </div>
                            <div class="form-group">
                                <label>Date de d√©but:</label>
                                <input type="date" name="startDate" required>
                            </div>
                            <div class="form-group">
                                <label>Date de fin:</label>
                                <input type="date" name="endDate" required>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">‚ûï Ajouter</button>
                    </form>
                </div>
                
                <div style="max-height: 400px; overflow-y: auto;">
                    <h3>üìã P√©riodes Existantes</h3>
                    <table class="ranking-table">
                        <thead>
                            <tr>
                                <th>Nom</th>
                                <th>D√©but</th>
                                <th>Fin</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            customPeriods.forEach((period, index) => {
                const isDefault = period.id === 'all' || period.id === '2024' || period.id === '2025';
                periodsHtml += `
                    <tr>
                        <td>${period.name}</td>
                        <td>${period.startDate ? new Date(period.startDate).toLocaleDateString('fr-FR') : 'D√©but'}</td>
                        <td>${period.endDate ? new Date(period.endDate).toLocaleDateString('fr-FR') : 'Fin'}</td>
                        <td>
                            ${!isDefault ? `
                                <button class="btn btn-warning" onclick="editPeriod(${index})" style="margin-right: 10px;">‚úèÔ∏è Modifier</button>
                                <button class="btn btn-danger" onclick="deletePeriod(${index})">üóëÔ∏è Supprimer</button>
                            ` : '<span style="color: #999;">P√©riode par d√©faut</span>'}
                        </td>
                    </tr>
                `;
            });

            periodsHtml += `
                        </tbody>
                    </table>
                </div>
                <br>
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Fermer</button>
            `;
            
            showModal(periodsHtml);
        }

        // Ajouter une p√©riode depuis la modal
        function addPeriodFromModal(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const newPeriod = {
                id: 'custom_' + Date.now(),
                name: formData.get('name'),
                startDate: formData.get('startDate'),
                endDate: formData.get('endDate')
            };
            
            customPeriods.push(newPeriod);
            updatePeriodButtons();
            autoSave();
            showManagePeriodsModal();
        }

        // Modifier une p√©riode
        function editPeriod(index) {
            const period = customPeriods[index];
            showModal(`
                <h2>‚úèÔ∏è Modifier la P√©riode</h2>
                <form onsubmit="updatePeriod(event, ${index})">
                    <div class="form-group">
                        <label>Nom de la p√©riode:</label>
                        <input type="text" name="name" value="${period.name}" required>
                    </div>
                    <div class="form-group">
                        <label>Date de d√©but:</label>
                        <input type="date" name="startDate" value="${period.startDate || ''}" required>
                    </div>
                    <div class="form-group">
                        <label>Date de fin:</label>
                        <input type="date" name="endDate" value="${period.endDate || ''}" required>
                    </div>
                    <button type="submit" class="btn btn-primary">üíæ Sauvegarder</button>
                    <button type="button" class="btn btn-secondary" onclick="showManagePeriodsModal()">‚¨ÖÔ∏è Retour</button>
                </form>
            `);
        }

        // Mettre √† jour une p√©riode
        function updatePeriod(event, index) {
            event.preventDefault();
            const formData = new FormData(event.target);
            
            customPeriods[index].name = formData.get('name');
            customPeriods[index].startDate = formData.get('startDate');
            customPeriods[index].endDate = formData.get('endDate');
            
            updatePeriodButtons();
            autoSave();
            showManagePeriodsModal();
        }

        // Supprimer une p√©riode
        function deletePeriod(index) {
            const period = customPeriods[index];
            
            if (confirm(`√ätes-vous s√ªr de vouloir supprimer la p√©riode "${period.name}" ?`)) {
                customPeriods.splice(index, 1);
                
                // Si la p√©riode supprim√©e √©tait active, revenir √† "Toute la saison"
                if (currentPeriod === period.id) {
                    showPeriod('all');
                }
                
                updatePeriodButtons();
                autoSave();
                showManagePeriodsModal();
            }
        }

        // Initialiser les donn√©es
        function initializeData() {
            // Si aucune donn√©e n'est charg√©e, initialiser avec des donn√©es de test
            if (players.length === 0) {
                players = [
                    { id: 1, prenom: 'Lucas', nom: 'MARTIN' },
                    { id: 2, prenom: 'Thomas', nom: 'BERNARD' },
                    { id: 3, prenom: 'Hugo', nom: 'DUBOIS' }
                ];
            }
            
            // Aucune session g√©n√©r√©e automatiquement - les sessions doivent √™tre ajout√©es manuellement
            
            // Initialiser les pr√©sences
            players.forEach(player => {
                if (!presences[player.id]) {
                    presences[player.id] = {};
                    sessions.forEach(session => {
                        presences[player.id][session.id] = 'pst';
                    });
                }
            });
        }

        // Mettre √† jour les statistiques
        function updateStats() {
            document.getElementById('totalPlayers').textContent = players.length;
            document.getElementById('totalSessions').textContent = sessions.length;
            
            let totalPresent = 0;
            let totalPossible = 0;
            
            players.forEach(player => {
                sessions.forEach(session => {
                    const status = presences[player.id] && presences[player.id][session.id];
                    // REP ne compte pas dans les calculs
                    if (status === 'rep') {
                        // Ne rien faire - REP est indicatif seulement
                    } else {
                        if (status === 'pst' || status === 'ret') {
                            totalPresent++;
                        }
                        totalPossible++;
                    }
                });
            });
            
            const avgRate = totalPossible > 0 ? Math.round((totalPresent / totalPossible) * 100) : 0;
            document.getElementById('avgAttendance').textContent = avgRate + '%';
        }

        // Rendre le tableau des pr√©sences
        function renderPresenceTable() {
            const headerRow = document.getElementById('headerRow');
            const presenceBody = document.getElementById('presenceBody');
            
            // Filtrer les sessions selon la p√©riode
            let filteredSessions = sessions;
            const currentPeriodObj = customPeriods.find(p => p.id === currentPeriod);
            
            if (currentPeriodObj && currentPeriodObj.startDate && currentPeriodObj.endDate) {
                filteredSessions = sessions.filter(s => 
                    s.date >= currentPeriodObj.startDate && s.date <= currentPeriodObj.endDate
                );
            }
            
            // Trier les sessions par date d√©croissante (plus r√©cente √† gauche)
            filteredSessions.sort((a, b) => b.date.localeCompare(a.date));
            
            // R√©initialiser l'en-t√™te
            headerRow.innerHTML = '<th>Pr√©nom</th><th>Nom</th>';
            
            // Ajouter les colonnes de dates
            filteredSessions.forEach(session => {
                const th = document.createElement('th');
                const date = new Date(session.date);
                th.innerHTML = `${date.getDate()}/${date.getMonth() + 1}<br><small>${session.type}</small>`;
                th.style.whiteSpace = 'nowrap';
                
                // Ajouter une classe pour les colonnes Match
                if (session.type === 'Match') {
                    th.className = 'match-header';
                }
                
                headerRow.appendChild(th);
            });
            
            // Rendre les lignes des joueurs
            presenceBody.innerHTML = '';
            const sortedPlayers = getSortedPlayers();
            sortedPlayers.forEach(player => {
                const row = document.createElement('tr');
                row.innerHTML = `<td>${player.prenom}</td><td>${player.nom}</td>`;
                
                filteredSessions.forEach(session => {
                    const td = document.createElement('td');
                    const status = presences[player.id][session.id] || 'pst';
                    
                    // Ajouter une classe sp√©ciale pour les matchs
                    if (session.type === 'Match') {
                        td.className = 'match-session';
                    }
                    
                    const select = document.createElement('select');
                    select.className = `presence-cell status-${status}`;
                    select.onchange = function() {
                        updatePresence(player.id, session.id, this.value);
                        this.className = `presence-cell status-${this.value}`;
                    };
                    
                    const options = [
                        { value: 'pst', text: 'PST', class: 'opt-pst' },
                        { value: 'abp', text: 'AbP', class: 'opt-abp' },
                        { value: 'absp', text: 'AbSP', class: 'opt-absp' },
                        { value: 'bls', text: 'BLS', class: 'opt-bls' },
                        { value: 'vac', text: 'VAC', class: 'opt-vac' },
                        { value: 'rep', text: 'REP', class: 'opt-rep' },
                        { value: 'ca', text: 'Ca', class: 'opt-ca' },
                        { value: 'cb', text: 'Cb', class: 'opt-cb' },
                        { value: 'cc', text: 'Cc', class: 'opt-cc' },
                        { value: 'ret', text: 'RET', class: 'opt-ret' }
                    ];
                    
                    options.forEach(opt => {
                        const option = document.createElement('option');
                        option.value = opt.value;
                        option.textContent = opt.text;
                        option.className = opt.class;
                        select.appendChild(option);
                    });
                    
                    // D√©finir la valeur apr√®s avoir ajout√© toutes les options
                    select.value = status;
                    
                    td.appendChild(select);
                    row.appendChild(td);
                });
                
                presenceBody.appendChild(row);
            });
            
            // Optimiser pour mobile apr√®s rendu
            setTimeout(() => {
                optimizeTableForMobile();
                // Mettre √† jour la vue mobile si active
                if (mobileViewActive) {
                    initializeMobileView();
                }
            }, 100);
        }

        // Mettre √† jour une pr√©sence
        function updatePresence(playerId, sessionId, status) {
            presences[playerId][sessionId] = status;
            updateStats();
            autoSave();
        }

        // Fonction de tri des joueurs
        function sortPlayers() {
            currentSort = document.getElementById('sortSelect').value;
            renderPresenceTable();
        }
        
        // Obtenir les joueurs tri√©s selon la s√©lection
        function getSortedPlayers() {
            let sortedPlayers = [...players];
            
            switch(currentSort) {
                case 'alphabetical-prenom':
                    sortedPlayers.sort((a, b) => a.prenom.localeCompare(b.prenom));
                    break;
                case 'alphabetical-nom':
                    sortedPlayers.sort((a, b) => a.nom.localeCompare(b.nom));
                    break;
                case 'recent':
                    // Trier par date d'ajout (ID d√©croissant)
                    sortedPlayers.sort((a, b) => b.id - a.id);
                    break;
                default:
                    // Ordre par d√©faut (tel qu'ajout√©)
                    break;
            }
            
            return sortedPlayers;
        }
        
        // Fonction de recherche
        function performSearch() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            
            if (searchTerm === '') {
                // Si la recherche est vide, afficher tout normalement
                renderPresenceTable();
                return;
            }
            
            // Recherche de joueur uniquement
            searchByPlayer(searchTerm);
        }


        // Recherche par joueur - filtre les joueurs mais garde toutes les dates
        function searchByPlayer(searchTerm) {
            const headerRow = document.getElementById('headerRow');
            const presenceBody = document.getElementById('presenceBody');
            
            // Filtrer les sessions selon la p√©riode actuelle
            let filteredSessions = sessions;
            const currentPeriodObj = customPeriods.find(p => p.id === currentPeriod);
            
            if (currentPeriodObj && currentPeriodObj.startDate && currentPeriodObj.endDate) {
                filteredSessions = sessions.filter(s => 
                    s.date >= currentPeriodObj.startDate && s.date <= currentPeriodObj.endDate
                );
            }
            
            // Trier les sessions par date d√©croissante (plus r√©cente √† gauche)
            filteredSessions.sort((a, b) => b.date.localeCompare(a.date));
            
            // R√©initialiser l'en-t√™te
            headerRow.innerHTML = '<th>Pr√©nom</th><th>Nom</th>';
            
            // Ajouter les colonnes de dates
            filteredSessions.forEach(session => {
                const th = document.createElement('th');
                const date = new Date(session.date);
                th.innerHTML = `${date.getDate()}/${date.getMonth() + 1}<br><small>${session.type}</small>`;
                th.style.whiteSpace = 'nowrap';
                headerRow.appendChild(th);
            });
            
            // Filtrer les joueurs correspondants √† la recherche
            const sortedPlayers = getSortedPlayers();
            const filteredPlayers = sortedPlayers.filter(player => 
                player.prenom.toLowerCase().includes(searchTerm) || 
                player.nom.toLowerCase().includes(searchTerm)
            );
            
            // Rendre les lignes des joueurs filtr√©s
            presenceBody.innerHTML = '';
            filteredPlayers.forEach(player => {
                const row = document.createElement('tr');
                
                
                // Mettre en √©vidence le texte correspondant
                const prenomHighlighted = highlightSearchTerm(player.prenom, searchTerm);
                const nomHighlighted = highlightSearchTerm(player.nom, searchTerm);
                
                row.innerHTML = `<td>${prenomHighlighted}</td><td>${nomHighlighted}</td>`;
                
                filteredSessions.forEach(session => {
                    const td = document.createElement('td');
                    const status = presences[player.id][session.id] || 'pst';
                    
                    // Ajouter une classe sp√©ciale pour les matchs
                    if (session.type === 'Match') {
                        td.className = 'match-session';
                    }
                    
                    const select = document.createElement('select');
                    select.className = `presence-cell status-${status}`;
                    select.onchange = function() {
                        updatePresence(player.id, session.id, this.value);
                        this.className = `presence-cell status-${this.value}`;
                    };
                    
                    const options = [
                        { value: 'pst', text: 'PST', class: 'opt-pst' },
                        { value: 'abp', text: 'AbP', class: 'opt-abp' },
                        { value: 'absp', text: 'AbSP', class: 'opt-absp' },
                        { value: 'bls', text: 'BLS', class: 'opt-bls' },
                        { value: 'vac', text: 'VAC', class: 'opt-vac' },
                        { value: 'rep', text: 'REP', class: 'opt-rep' },
                        { value: 'ca', text: 'Ca', class: 'opt-ca' },
                        { value: 'cb', text: 'Cb', class: 'opt-cb' },
                        { value: 'cc', text: 'Cc', class: 'opt-cc' },
                        { value: 'ret', text: 'RET', class: 'opt-ret' }
                    ];
                    
                    options.forEach(opt => {
                        const option = document.createElement('option');
                        option.value = opt.value;
                        option.textContent = opt.text;
                        option.className = opt.class;
                        select.appendChild(option);
                    });
                    
                    // D√©finir la valeur apr√®s avoir ajout√© toutes les options
                    select.value = status;
                    
                    td.appendChild(select);
                    row.appendChild(td);
                });
                
                presenceBody.appendChild(row);
            });
            
            // Afficher un message si aucun joueur trouv√©
            if (filteredPlayers.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="${filteredSessions.length + 2}" style="text-align: center; padding: 20px; color: #999; font-style: italic;">Aucun joueur trouv√© pour "${searchTerm}"</td>`;
                presenceBody.appendChild(row);
            }
            
            // Optimiser pour mobile apr√®s rendu
            setTimeout(() => {
                optimizeTableForMobile();
                // Mettre √† jour la vue mobile si active
                if (mobileViewActive) {
                    initializeMobileView();
                }
            }, 100);
        }

        // Fonction utilitaire pour surligner le texte de recherche
        function highlightSearchTerm(text, searchTerm) {
            const regex = new RegExp(`(${searchTerm})`, 'gi');
            return text.replace(regex, '<mark style="background-color: #ffc107; padding: 2px 4px; border-radius: 3px;">$1</mark>');
        }

        // Calculer les totaux
        function calculateTotals() {
            const rankings = players.map(player => {
                let present = 0;
                let total = 0; // On va compter seulement les sessions o√π REP n'est pas utilis√©
                let points = 0;
                let retards = 0;
                
                sessions.forEach(session => {
                    const status = presences[player.id][session.id];
                    
                    // REP ne compte pas dans les calculs
                    if (status === 'rep') {
                        // Ne rien faire - REP est indicatif seulement
                        return;
                    }
                    
                    total++; // Compter seulement si ce n'est pas REP
                    
                    if (status === 'pst' && session.type === 'Entra√Ænement') {
                        present++;
                        points += 3;
                    } else if (status === 'ret' && session.type === 'Entra√Ænement') {
                        present++; // Un retard compte comme une pr√©sence
                        retards++; // Mais on compte aussi les retards
                        points += 3;
                    } else if (status === 'vac') {
                        points += 1;
                    } else if (status === 'ca' || status === 'cb' || status === 'cc') {
                        present++;
                        points += 3;
                    }
                });
                
                const rate = total > 0 ? Math.round((present / total) * 100) : 0;
                
                return {
                    ...player,
                    present,
                    total,
                    rate,
                    points,
                    retards
                };
            }).sort((a, b) => b.rate - a.rate);
            
            // Mettre √† jour les stats
            if (rankings.length > 0) {
                document.getElementById('bestPlayer').textContent = rankings[0].prenom + ' ' + rankings[0].nom;
                document.getElementById('bestRate').textContent = rankings[0].rate + '%';
            }
            document.getElementById('totalTrainings').textContent = sessions.filter(s => s.type === 'Entra√Ænement').length;
            
            // Rendre le tableau
            const rankingBody = document.getElementById('rankingBody');
            rankingBody.innerHTML = '';
            
            rankings.forEach((player, index) => {
                const row = document.createElement('tr');
                let rankDisplay = (index + 1).toString();
                if (index === 0) rankDisplay = 'ü•á 1';
                else if (index === 1) rankDisplay = 'ü•à 2';
                else if (index === 2) rankDisplay = 'ü•â 3';
                
                const badges = [];
                if (player.rate >= 90 && player.retards < 5) badges.push('<span class="badge badge-assidu">Assidu</span>');
                if (player.rate >= 75) badges.push('<span class="badge badge-regulier">R√©gulier</span>');
                if (player.retards >= 5) badges.push('<span class="badge badge-warning">‚è∞ Souvent en Retard</span>');
                
                row.innerHTML = `
                    <td><span class="rank-medal rank-${index + 1}">${rankDisplay}</span></td>
                    <td>${player.prenom}</td>
                    <td>${player.nom}</td>
                    <td>${player.present}/${player.total}</td>
                    <td>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${player.rate}%"></div>
                        </div>
                        ${player.rate}%
                    </td>
                    <td>${player.points}</td>
                    <td>${badges.join(' ')}</td>
                `;
                rankingBody.appendChild(row);
            });
            
            // Mettre √† jour les graphiques
            updateCharts(rankings);
        }

        // Mettre √† jour la comp√©tition
        function updateCompetition() {
            const competitionData = players.map(player => {
                let present = 0;
                let repos = 0;
                let absent = 0;
                let retards = 0;
                let totalSessions = 0;
                
                sessions.forEach(session => {
                    const status = presences[player.id][session.id];
                    
                    // REP doesn't count in calculations
                    if (status === 'rep') {
                        repos++;
                        return;
                    }
                    
                    totalSessions++;
                    
                    if (status === 'pst') {
                        present++;
                    } else if (status === 'vac') {
                        repos++;
                    } else if (status === 'abp' || status === 'absp' || status === 'bls') {
                        absent++;
                    } else if (status === 'ca' || status === 'cb' || status === 'cc') {
                        present++;
                    } else if (status === 'ret') {
                        retards++;
                        present++; // Un retard compte comme une pr√©sence
                    }
                });
                
                // Calcul du taux d'assiduit√© (pr√©sences + retards) / (total - vacances)
                const effectiveSessions = totalSessions - repos;
                const attendanceRate = effectiveSessions > 0 ? Math.round(((present) / effectiveSessions) * 100) : 0;
                
                return {
                    ...player,
                    present,
                    repos,
                    absent,
                    retards,
                    attendanceRate,
                    totalSessions
                };
            }).sort((a, b) => {
                // Trier d'abord par taux d'assiduit√©, puis par nombre de pr√©sences
                if (b.attendanceRate === a.attendanceRate) {
                    return b.present - a.present;
                }
                return b.attendanceRate - a.attendanceRate;
            });
            
            // Mettre √† jour les stats
            if (competitionData.length > 0) {
                document.getElementById('monthWinner').textContent = competitionData[0].prenom + ' ' + competitionData[0].nom;
                document.getElementById('bestAttendanceRate').textContent = competitionData[0].attendanceRate + '%';
                
                // Calcul de la moyenne g√©n√©rale
                const averageRate = Math.round(competitionData.reduce((sum, p) => sum + p.attendanceRate, 0) / competitionData.length);
                document.getElementById('averageAttendance').textContent = averageRate + '%';
            }
            
            const perfectPlayers = competitionData.filter(p => p.absent === 0).length;
            document.getElementById('perfectPlayers').textContent = perfectPlayers;
            
            // Rendre le tableau
            const competitionBody = document.getElementById('competitionBody');
            competitionBody.innerHTML = '';
            
            competitionData.forEach((player, index) => {
                const row = document.createElement('tr');
                let rankDisplay = (index + 1).toString();
                if (index === 0) rankDisplay = 'ü•á 1';
                else if (index === 1) rankDisplay = 'ü•à 2';
                else if (index === 2) rankDisplay = 'ü•â 3';
                
                const badges = [];
                if (index === 0) badges.push('<span class="badge badge-gold">üèÜ Champion</span>');
                if (index === 1) badges.push('<span class="badge badge-silver">ü•à Vice-Champion</span>');
                if (index === 2) badges.push('<span class="badge badge-bronze">ü•â 3√®me</span>');
                if (player.absent === 0 && player.retards < 5) badges.push('<span class="badge badge-assidu">‚≠ê Sans Absence</span>');
                if (player.attendanceRate === 100 && player.retards < 5) badges.push('<span class="badge badge-assidu">üíØ Parfait</span>');
                if (player.retards === 0 && player.present > 0) badges.push('<span class="badge badge-regulier">‚è∞ Ponctuel</span>');
                if (player.retards >= 5) badges.push('<span class="badge badge-warning">‚è∞ Souvent en Retard</span>');
                
                row.innerHTML = `
                    <td><span class="rank-medal rank-${index + 1}">${rankDisplay}</span></td>
                    <td>${player.prenom}</td>
                    <td>${player.nom}</td>
                    <td>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${player.attendanceRate}%"></div>
                        </div>
                        <strong>${player.attendanceRate}%</strong>
                    </td>
                    <td>${player.present}</td>
                    <td>${player.repos}</td>
                    <td>${player.absent}</td>
                    <td>${player.retards}</td>
                    <td>${badges.join(' ')}</td>
                `;
                competitionBody.appendChild(row);
            });
            
            updateCompetitionCharts(competitionData);
        }

        // Mettre √† jour les graphiques
        function updateCharts(rankings) {
            // Top 10 Chart
            const top10 = rankings.slice(0, 10);
            const ctx1 = document.getElementById('top10Chart').getContext('2d');
            
            new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: top10.map(p => p.prenom),
                    datasets: [{
                        label: 'Taux de pr√©sence (%)',
                        data: top10.map(p => p.rate),
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
            
            // Evolution Chart (exemple avec donn√©es fictives)
            const ctx2 = document.getElementById('evolutionChart').getContext('2d');
            const months = ['Ao√ªt', 'Sept', 'Oct', 'Nov', 'D√©c', 'Jan', 'F√©v', 'Mars', 'Avril', 'Mai'];
            const evolutionData = months.map(() => Math.floor(Math.random() * 20) + 60);
            
            new Chart(ctx2, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'Taux de pr√©sence moyen (%)',
                        data: evolutionData,
                        borderColor: 'rgba(118, 75, 162, 1)',
                        backgroundColor: 'rgba(118, 75, 162, 0.2)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }

        // Mettre √† jour les graphiques de comp√©tition
        function updateCompetitionCharts(data) {
            // Taux d'Assiduit√© Chart
            const ctx1 = document.getElementById('pointsChart').getContext('2d');
            const top10 = data.slice(0, 10);
            
            new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: top10.map(p => p.prenom),
                    datasets: [{
                        label: 'Taux d\'Assiduit√© (%)',
                        data: top10.map(p => p.attendanceRate),
                        backgroundColor: top10.map((_, i) => {
                            if (i === 0) return '#FFD700';
                            if (i === 1) return '#C0C0C0';
                            if (i === 2) return '#CD7F32';
                            return 'rgba(102, 126, 234, 0.8)';
                        }),
                        borderColor: top10.map((_, i) => {
                            if (i === 0) return '#DAA520';
                            if (i === 1) return '#A0A0A0';
                            if (i === 2) return '#B8860B';
                            return 'rgba(102, 126, 234, 1)';
                        }),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true
                        },
                        title: {
                            display: true,
                            text: 'Top 10 - Taux d\'Assiduit√©'
                        }
                    }
                }
            });
            
            // R√©partition des Statuts Chart
            const ctx2 = document.getElementById('badgesChart').getContext('2d');
            
            // Calculer les totaux pour tous les joueurs
            let totalPresences = 0;
            let totalAbsences = 0;
            let totalVacances = 0;
            let totalRetards = 0;
            
            data.forEach(player => {
                totalPresences += player.present - player.retards; // Pr√©sences sans les retards
                totalAbsences += player.absent;
                totalVacances += player.repos;
                totalRetards += player.retards;
            });
            
            new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: ['Pr√©sences', 'Retards', 'Vacances', 'Absences'],
                    datasets: [{
                        data: [totalPresences, totalRetards, totalVacances, totalAbsences],
                        backgroundColor: ['#28a745', '#ffc107', '#17a2b8', '#dc3545'],
                        borderColor: ['#1e7e34', '#e0a800', '#138496', '#c82333'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        title: {
                            display: true,
                            text: 'R√©partition G√©n√©rale des Statuts'
                        }
                    }
                }
            });
        }

        // Modal functions
        function showModal(content) {
            document.getElementById('modalContent').innerHTML = content;
            document.getElementById('modal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }

        window.onclick = function(event) {
            const modal = document.getElementById('modal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }


        // G√©rer les joueurs (ajout/modification/suppression)
        function showManagePlayersModal() {
            let playersHtml = `
                <h2>üë• G√©rer les Joueurs</h2>
                
                <div style="background: #f8f9ff; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3>‚ûï Ajouter un Nouveau Joueur</h3>
                    <form onsubmit="addPlayerFromModal(event)">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div class="form-group">
                                <label>Pr√©nom:</label>
                                <input type="text" name="prenom" required>
                            </div>
                            <div class="form-group">
                                <label>Nom:</label>
                                <input type="text" name="nom" required>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">‚ûï Ajouter</button>
                    </form>
                </div>
                
                <div style="max-height: 400px; overflow-y: auto;">
                    <h3>üìã Joueurs Existants</h3>
            `;
            
            if (players.length === 0) {
                playersHtml += '<p>Aucun joueur enregistr√©.</p>';
            } else {
                playersHtml += '<table class="ranking-table"><thead><tr><th>Pr√©nom</th><th>Nom</th><th>Actions</th></tr></thead><tbody>';
                
                players.forEach((player, index) => {
                    playersHtml += `
                        <tr>
                            <td>${player.prenom}</td>
                            <td>${player.nom}</td>
                            <td>
                                <button class="btn btn-warning" onclick="editPlayer(${index})" style="margin-right: 10px;">‚úèÔ∏è Modifier</button>
                                <button class="btn btn-danger" onclick="deletePlayer(${index})">üóëÔ∏è Supprimer</button>
                            </td>
                        </tr>
                    `;
                });
                
                playersHtml += '</tbody></table>';
            }
            
            playersHtml += '</div><br><button type="button" class="btn btn-secondary" onclick="closeModal()">Fermer</button>';
            showModal(playersHtml);
        }

        // Ajouter un joueur depuis la modal de gestion
        function addPlayerFromModal(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const newPlayer = {
                id: Date.now(),
                prenom: formData.get('prenom'),
                nom: formData.get('nom')
            };
            
            players.push(newPlayer);
            presences[newPlayer.id] = {};
            
            // Initialiser les pr√©sences pour ce joueur avec REPOS par d√©faut
            sessions.forEach(session => {
                presences[newPlayer.id][session.id] = 'rep';
            });
            
            updateStats();
            renderPresenceTable();
            autoSave();
            showManagePlayersModal(); // Recharger la modal
        }

        // Modifier un joueur
        function editPlayer(index) {
            const player = players[index];
            showModal(`
                <h2>‚úèÔ∏è Modifier le Joueur</h2>
                <form onsubmit="updatePlayer(event, ${index})">
                    <div class="form-group">
                        <label>Pr√©nom:</label>
                        <input type="text" name="prenom" value="${player.prenom}" required>
                    </div>
                    <div class="form-group">
                        <label>Nom:</label>
                        <input type="text" name="nom" value="${player.nom}" required>
                    </div>
                    <button type="submit" class="btn btn-primary">üíæ Sauvegarder</button>
                    <button type="button" class="btn btn-secondary" onclick="showManagePlayersModal()">‚¨ÖÔ∏è Retour</button>
                </form>
            `);
        }

        // Mettre √† jour un joueur
        function updatePlayer(event, index) {
            event.preventDefault();
            const formData = new FormData(event.target);
            
            players[index].prenom = formData.get('prenom');
            players[index].nom = formData.get('nom');
            
            updateStats();
            renderPresenceTable();
            autoSave();
            showManagePlayersModal();
        }

        // Supprimer un joueur
        function deletePlayer(index) {
            const player = players[index];
            
            if (confirm(`√ätes-vous s√ªr de vouloir supprimer ${player.prenom} ${player.nom} ?\n\nAttention : Toutes ses donn√©es de pr√©sence seront d√©finitivement perdues !`)) {
                // Supprimer les donn√©es de pr√©sence du joueur
                delete presences[player.id];
                
                // Supprimer le joueur de la liste
                players.splice(index, 1);
                
                updateStats();
                renderPresenceTable();
                autoSave();
                showManagePlayersModal();
            }
        }



        // G√©rer les dates/sessions (ajout/modification/suppression)
        function showManageDatesModal() {
            let datesHtml = `
                <h2>üìÖ G√©rer les Dates</h2>
                
                <div style="background: #f8f9ff; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3>‚ûï Ajouter une Nouvelle Date</h3>
                    <form onsubmit="addDateFromModal(event)">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div class="form-group">
                                <label>Date:</label>
                                <input type="date" name="date" required>
                            </div>
                            <div class="form-group">
                                <label>Type:</label>
                                <select name="type" required>
                                    <option value="Entra√Ænement">Entra√Ænement</option>
                                    <option value="Match">Match</option>
                                </select>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">‚ûï Ajouter</button>
                    </form>
                </div>
                
                <div style="max-height: 400px; overflow-y: auto;">
                    <h3>üìã Sessions Existantes</h3>
            `;
            
            if (sessions.length === 0) {
                datesHtml += '<p>Aucune session enregistr√©e.</p>';
            } else {
                datesHtml += '<table class="ranking-table"><thead><tr><th>Date</th><th>Type</th><th>Actions</th></tr></thead><tbody>';
                
                // Trier les sessions par date pour un affichage chronologique (plus r√©cente en premier)
                const sortedSessions = [...sessions].sort((a, b) => b.date.localeCompare(a.date));
                
                sortedSessions.forEach((session) => {
                    const sessionIndex = sessions.findIndex(s => s.id === session.id);
                    const formattedDate = new Date(session.date).toLocaleDateString('fr-FR');
                    
                    datesHtml += `
                        <tr>
                            <td>${formattedDate}</td>
                            <td><span class="badge ${session.type === 'Match' ? 'badge-gold' : 'badge-regulier'}">${session.type}</span></td>
                            <td>
                                <button class="btn btn-warning" onclick="editSession(${sessionIndex})" style="margin-right: 10px;">‚úèÔ∏è Modifier</button>
                                <button class="btn btn-danger" onclick="deleteSession(${sessionIndex})">üóëÔ∏è Supprimer</button>
                            </td>
                        </tr>
                    `;
                });
                
                datesHtml += '</tbody></table>';
            }
            
            datesHtml += '</div><br><button type="button" class="btn btn-secondary" onclick="closeModal()">Fermer</button>';
            showModal(datesHtml);
        }

        // Ajouter une date depuis la modal de gestion
        function addDateFromModal(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const newSession = {
                id: Date.now(),
                date: formData.get('date'),
                type: formData.get('type')
            };
            
            sessions.push(newSession);
            sessions.sort((a, b) => b.date.localeCompare(a.date));
            
            // Initialiser les pr√©sences pour cette session avec REPOS par d√©faut
            // ou appliquer les statuts programm√©s
            players.forEach(player => {
                const scheduledStatus = getScheduledAbsence(player.id, newSession.date);
                if (scheduledStatus) {
                    // Appliquer le statut programm√©
                    presences[player.id][newSession.id] = scheduledStatus.absenceType;
                } else {
                    // Statut REPOS par d√©faut
                    presences[player.id][newSession.id] = 'rep';
                }
            });
            
            updateStats();
            renderPresenceTable();
            autoSave();
            showManageDatesModal(); // Recharger la modal
        }

        // Modifier une session
        function editSession(index) {
            const session = sessions[index];
            showModal(`
                <h2>‚úèÔ∏è Modifier la Session</h2>
                <form onsubmit="updateSession(event, ${index})">
                    <div class="form-group">
                        <label>Date:</label>
                        <input type="date" name="date" value="${session.date}" required>
                    </div>
                    <div class="form-group">
                        <label>Type:</label>
                        <select name="type" required>
                            <option value="Entra√Ænement" ${session.type === 'Entra√Ænement' ? 'selected' : ''}>Entra√Ænement</option>
                            <option value="Match" ${session.type === 'Match' ? 'selected' : ''}>Match</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">üíæ Sauvegarder</button>
                    <button type="button" class="btn btn-secondary" onclick="showManageDatesModal()">‚¨ÖÔ∏è Retour</button>
                </form>
            `);
        }

        // Mettre √† jour une session
        function updateSession(event, index) {
            event.preventDefault();
            const formData = new FormData(event.target);
            
            sessions[index].date = formData.get('date');
            sessions[index].type = formData.get('type');
            
            // Retrier les sessions par date (plus r√©cente √† gauche)
            sessions.sort((a, b) => b.date.localeCompare(a.date));
            
            updateStats();
            renderPresenceTable();
            autoSave();
            showManageDatesModal();
        }

        // Supprimer une session
        function deleteSession(index) {
            const session = sessions[index];
            const formattedDate = new Date(session.date).toLocaleDateString('fr-FR');
            
            if (confirm(`√ätes-vous s√ªr de vouloir supprimer la session du ${formattedDate} (${session.type}) ?\n\nAttention : Toutes les donn√©es de pr√©sence pour cette session seront d√©finitivement perdues !`)) {
                // Supprimer les donn√©es de pr√©sence pour cette session
                players.forEach(player => {
                    if (presences[player.id]) {
                        delete presences[player.id][session.id];
                    }
                });
                
                // Supprimer la session
                sessions.splice(index, 1);
                
                updateStats();
                renderPresenceTable();
                autoSave();
                showManageDatesModal();
            }
        }


        // Sauvegarder les donn√©es sur Firebase
        async function saveData() {
            if (isFirebaseInitialized) {
                await saveDataToFirebase();
                alert('Donn√©es sauvegard√©es sur Firebase ! üî•');
            } else {
                // Fallback localStorage
                const data = {
                    players,
                    sessions,
                    presences,
                    customPeriods,
                    scheduledAbsences
                };
                localStorage.setItem('senior2526Data', JSON.stringify(data));
                alert('Donn√©es sauvegard√©es localement !');
            }
        }

        // Sauvegarder automatiquement sans alerte
        async function autoSave() {
            if (isFirebaseInitialized) {
                await saveDataToFirebase();
            } else {
                // Fallback localStorage
                const data = {
                    players,
                    sessions,
                    presences,
                    customPeriods,
                    scheduledAbsences
                };
                localStorage.setItem('senior2526Data', JSON.stringify(data));
            }
        }
        
        // Sauvegarder sur Firebase
        async function saveDataToFirebase() {
            try {
                const { doc, setDoc } = window.firebaseServices;
                const dataRef = doc(window.db, 'seniorData', 'main');
                
                const data = {
                    players,
                    sessions,
                    presences,
                    customPeriods,
                    scheduledAbsences,
                    lastUpdated: new Date().toISOString()
                };
                
                await setDoc(dataRef, data);
                console.log('‚úÖ Donn√©es sauvegard√©es sur Firebase');
            } catch (error) {
                console.error('‚ùå Erreur sauvegarde Firebase:', error);
            }
        }
        
        // Charger les donn√©es depuis Firebase
        async function loadDataFromFirebase() {
            try {
                const { doc, getDoc, onSnapshot } = window.firebaseServices;
                const dataRef = doc(window.db, 'seniorData', 'main');
                
                // √âcouter les changements en temps r√©el
                const unsubscribe = onSnapshot(dataRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        console.log('üîÑ Donn√©es mises √† jour depuis Firebase');
                        
                        // V√©rifier si les donn√©es ont chang√© pour √©viter les mises √† jour inutiles
                        const hasChanged = JSON.stringify({players, sessions, presences, customPeriods, scheduledAbsences}) !== 
                                         JSON.stringify({players: data.players || [], sessions: data.sessions || [], presences: data.presences || {}, customPeriods: data.customPeriods, scheduledAbsences: data.scheduledAbsences || []});
                        
                        if (hasChanged) {
                            players = data.players || [];
                            sessions = data.sessions || [];
                            presences = data.presences || {};
                            scheduledAbsences = data.scheduledAbsences || [];
                            if (data.customPeriods) {
                                customPeriods = data.customPeriods;
                            }
                            
                            // Mettre √† jour l'interface
                            updateStats();
                            updatePeriodButtons();
                            renderPresenceTable();
                            
                            // Afficher un indicateur de synchronisation seulement si les donn√©es ont chang√©
                            showSyncIndicator();
                        }
                    } else {
                        console.log('üì¶ Aucune donn√©e Firebase, initialisation...');
                        initializeData();
                        updateStats();
                        updatePeriodButtons();
                        renderPresenceTable();
                        saveDataToFirebase(); // Cr√©er les donn√©es initiales
                    }
                });
                
                unsubscribeListeners.push(unsubscribe);
                
            } catch (error) {
                console.error('‚ùå Erreur chargement Firebase:', error);
                // Fallback sur localStorage
                loadData();
                initializeData();
                updateStats();
                updatePeriodButtons();
                renderPresenceTable();
            }
        }
        
        // Charger les donn√©es depuis localStorage (fallback)
        function loadData() {
            const savedData = localStorage.getItem('senior2526Data');
            if (savedData) {
                const data = JSON.parse(savedData);
                players = data.players || [];
                sessions = data.sessions || [];
                presences = data.presences || {};
                scheduledAbsences = data.scheduledAbsences || [];
                if (data.customPeriods) {
                    customPeriods = data.customPeriods;
                }
            }
        }
        
        // Afficher un indicateur de synchronisation
        function showSyncIndicator() {
            // Cr√©er un indicateur temporaire
            const indicator = document.createElement('div');
            indicator.innerHTML = 'üîÑ Synchronis√©';
            indicator.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #28a745;
                color: white;
                padding: 10px 15px;
                border-radius: 20px;
                font-size: 14px;
                font-weight: 600;
                z-index: 1000;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                animation: fadeInOut 2s ease-in-out;
            `;
            
            // Ajouter l'animation CSS
            if (!document.getElementById('syncAnimation')) {
                const style = document.createElement('style');
                style.id = 'syncAnimation';
                style.textContent = `
                    @keyframes fadeInOut {
                        0% { opacity: 0; transform: translateY(-20px); }
                        50% { opacity: 1; transform: translateY(0); }
                        100% { opacity: 0; transform: translateY(-20px); }
                    }
                `;
                document.head.appendChild(style);
            }
            
            document.body.appendChild(indicator);
            
            // Supprimer apr√®s 2 secondes
            setTimeout(() => {
                if (indicator.parentNode) {
                    indicator.parentNode.removeChild(indicator);
                }
            }, 2000);
        }

        // Export PDF functions
        function exportRankingPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // En-t√™te
            doc.setFontSize(20);
            doc.text('Senior - Classement des Pr√©sences', 105, 20, { align: 'center' });
            
            // Date
            doc.setFontSize(12);
            doc.text(new Date().toLocaleDateString('fr-FR'), 105, 30, { align: 'center' });
            
            // Calculer les donn√©es
            const rankings = players.map(player => {
                let present = 0;
                let total = sessions.length;
                
                sessions.forEach(session => {
                    const status = presences[player.id][session.id];
                    if (status === 'pst') {
                        present++;
                    }
                });
                
                const rate = total > 0 ? Math.round((present / total) * 100) : 0;
                
                return {
                    prenom: player.prenom,
                    nom: player.nom,
                    presences: `${present}/${total}`,
                    taux: `${rate}%`
                };
            }).sort((a, b) => parseInt(b.taux) - parseInt(a.taux));
            
            // Tableau
            doc.autoTable({
                head: [['Rang', 'Pr√©nom', 'Nom', 'Pr√©sences', 'Taux']],
                body: rankings.map((player, index) => [
                    index + 1,
                    player.prenom,
                    player.nom,
                    player.presences,
                    player.taux
                ]),
                startY: 40,
                theme: 'grid',
                headStyles: { fillColor: [102, 126, 234] }
            });
            
            // Footer
            doc.setFontSize(10);
            doc.text('G√©n√©r√© avec Claude Code', 105, doc.internal.pageSize.height - 10, { align: 'center' });
            
            doc.save('classement_presences_senior.pdf');
        }

        function exportTop10PDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // En-t√™te
            doc.setFontSize(20);
            doc.text('Senior - Top 10 des Pr√©sences', 105, 20, { align: 'center' });
            
            // Calculer les donn√©es
            const rankings = players.map(player => {
                let present = 0;
                let total = sessions.length;
                
                sessions.forEach(session => {
                    const status = presences[player.id][session.id];
                    if (status === 'pst') {
                        present++;
                    }
                });
                
                const rate = total > 0 ? Math.round((present / total) * 100) : 0;
                
                return {
                    prenom: player.prenom,
                    nom: player.nom,
                    presences: `${present}/${total}`,
                    taux: `${rate}%`
                };
            }).sort((a, b) => parseInt(b.taux) - parseInt(a.taux)).slice(0, 10);
            
            // Tableau
            doc.autoTable({
                head: [['Rang', 'Pr√©nom', 'Nom', 'Pr√©sences', 'Taux']],
                body: rankings.map((player, index) => {
                    let rang = (index + 1).toString();
                    if (index === 0) rang = 'ü•á 1';
                    else if (index === 1) rang = 'ü•à 2';
                    else if (index === 2) rang = 'ü•â 3';
                    
                    return [rang, player.prenom, player.nom, player.presences, player.taux];
                }),
                startY: 40,
                theme: 'striped',
                headStyles: { fillColor: [102, 126, 234] }
            });
            
            doc.save('top10_presences_senior.pdf');
        }

        function exportCompetitionPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // En-t√™te
            doc.setFontSize(20);
            doc.text('Senior - Classement par Assiduit√©', 105, 20, { align: 'center' });
            
            // Date
            doc.setFontSize(12);
            doc.text(new Date().toLocaleDateString('fr-FR'), 105, 30, { align: 'center' });
            
            // Calculer les donn√©es de comp√©tition
            const competitionData = players.map(player => {
                let present = 0;
                let repos = 0;
                let absent = 0;
                let retards = 0;
                let totalSessions = 0;
                
                sessions.forEach(session => {
                    const status = presences[player.id][session.id];
                    totalSessions++;
                    
                    if (status === 'pst') {
                        present++;
                    } else if (status === 'vac') {
                        repos++;
                    } else if (status === 'abp' || status === 'absp' || status === 'bls') {
                        absent++;
                    } else if (status === 'ca' || status === 'cb' || status === 'cc') {
                        present++;
                    } else if (status === 'ret') {
                        retards++;
                        present++;
                    }
                });
                
                const effectiveSessions = totalSessions - repos;
                const attendanceRate = effectiveSessions > 0 ? Math.round(((present) / effectiveSessions) * 100) : 0;
                
                return {
                    prenom: player.prenom,
                    nom: player.nom,
                    attendanceRate: attendanceRate,
                    present: present,
                    absent: absent,
                    retards: retards
                };
            }).sort((a, b) => {
                if (b.attendanceRate === a.attendanceRate) {
                    return b.present - a.present;
                }
                return b.attendanceRate - a.attendanceRate;
            });
            
            // Tableau
            doc.autoTable({
                head: [['Rang', 'Pr√©nom', 'Nom', 'Taux Assiduit√©', 'Pr√©sences', 'Absences', 'Retards']],
                body: competitionData.map((player, index) => {
                    let rang = (index + 1).toString();
                    if (index === 0) rang = 'üèÜ 1';
                    else if (index === 1) rang = 'ü•à 2';
                    else if (index === 2) rang = 'ü•â 3';
                    
                    return [rang, player.prenom, player.nom, player.attendanceRate + '%', player.present, player.absent, player.retards];
                }),
                startY: 40,
                theme: 'grid',
                headStyles: { fillColor: [118, 75, 162] }
            });
            
            // Footer
            doc.setFontSize(10);
            doc.text('G√©n√©r√© avec Claude Code', 105, doc.internal.pageSize.height - 10, { align: 'center' });
            
            doc.save('classement_assiduites_senior.pdf');
        }

        // Modal pour g√©rer les absences programm√©es
        function showScheduledAbsencesModal() {
            const today = new Date().toISOString().split('T')[0];
            
            let modalHtml = `
                <h2>üóìÔ∏è Gestion des Statuts Programm√©s</h2>
                
                <div style="background: #f8f9ff; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3>‚ûï Programmer un nouveau statut</h3>
                    <form onsubmit="addScheduledAbsence(event)">
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label>Joueur :</label>
                            <select name="playerId" required style="width: 100%; padding: 8px;">
                                <option value="">-- S√©lectionner un joueur --</option>
                                ${players.map(player => `<option value="${player.id}">${player.prenom} ${player.nom}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label>Statut √† appliquer :</label>
                            <select name="absenceType" required style="width: 100%; padding: 8px;">
                                <option value="pst">Pr√©sent (PST)</option>
                                <option value="abp">Absent Pr√©venu (AbP)</option>
                                <option value="absp">Absent Sans Pr√©venir (AbSP)</option>
                                <option value="bls">Bless√© (BLS)</option>
                                <option value="vac">Vacances (VAC)</option>
                                <option value="rep">Repos (REP)</option>
                                <option value="ca">Convoqu√© A (Ca)</option>
                                <option value="cb">Convoqu√© B (Cb)</option>
                                <option value="cc">Convoqu√© C (Cc)</option>
                                <option value="ret">Retard (RET)</option>
                            </select>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div class="form-group">
                                <label>Date de d√©but :</label>
                                <input type="date" name="startDate" value="${today}" required style="width: 100%; padding: 8px;">
                            </div>
                            <div class="form-group">
                                <label>Date de fin :</label>
                                <input type="date" name="endDate" value="${today}" required style="width: 100%; padding: 8px;">
                            </div>
                        </div>
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label>Commentaire (optionnel) :</label>
                            <input type="text" name="comment" placeholder="Ex: Vacances en famille" style="width: 100%; padding: 8px;">
                        </div>
                        <button type="submit" class="btn btn-primary">‚ûï Programmer le statut</button>
                    </form>
                </div>
                
                <div style="max-height: 400px; overflow-y: auto;">
                    <h3>üìã Statuts programm√©s</h3>
            `;
            
            if (scheduledAbsences.length === 0) {
                modalHtml += '<p style="color: #666;">Aucun statut programm√©.</p>';
            } else {
                modalHtml += `
                    <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                        <thead>
                            <tr style="background: #f5f5f5;">
                                <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Joueur</th>
                                <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Type</th>
                                <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">P√©riode</th>
                                <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Commentaire</th>
                                <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                scheduledAbsences.forEach((absence, index) => {
                    const player = players.find(p => p.id === absence.playerId);
                    const playerName = player ? `${player.prenom} ${player.nom}` : 'Joueur supprim√©';
                    const startDate = new Date(absence.startDate).toLocaleDateString('fr-FR');
                    const endDate = new Date(absence.endDate).toLocaleDateString('fr-FR');
                    const typeText = {
                        'pst': 'Pr√©sent',
                        'abp': 'Absent Pr√©venu',
                        'absp': 'Absent Sans Pr√©venir',
                        'bls': 'Bless√©',
                        'vac': 'Vacances',
                        'rep': 'Repos',
                        'ca': 'Convoqu√© A',
                        'cb': 'Convoqu√© B', 
                        'cc': 'Convoqu√© C',
                        'ret': 'Retard'
                    };
                    
                    modalHtml += `
                        <tr>
                            <td style="padding: 12px; border: 1px solid #ddd;">${playerName}</td>
                            <td style="padding: 12px; border: 1px solid #ddd;">
                                <span class="status-${absence.absenceType}" style="padding: 4px 8px; border-radius: 4px; font-weight: 600; font-size: 12px;">
                                    ${typeText[absence.absenceType]}
                                </span>
                            </td>
                            <td style="padding: 12px; border: 1px solid #ddd;">${startDate} ‚Üí ${endDate}</td>
                            <td style="padding: 12px; border: 1px solid #ddd;">${absence.comment || '-'}</td>
                            <td style="padding: 12px; border: 1px solid #ddd;">
                                <button class="btn btn-danger" onclick="deleteScheduledAbsence(${index})" style="font-size: 12px;">üóëÔ∏è Supprimer</button>
                            </td>
                        </tr>
                    `;
                });
                
                modalHtml += '</tbody></table>';
            }
            
            modalHtml += '</div><br><button type="button" class="btn btn-secondary" onclick="closeModal()">Fermer</button>';
            showModal(modalHtml);
        }

        // Ajouter une absence programm√©e
        function addScheduledAbsence(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            
            const newAbsence = {
                id: Date.now(),
                playerId: parseInt(formData.get('playerId')),
                absenceType: formData.get('absenceType'),
                startDate: formData.get('startDate'),
                endDate: formData.get('endDate'),
                comment: formData.get('comment') || ''
            };
            
            // V√©rifier que la date de fin est apr√®s la date de d√©but
            if (new Date(newAbsence.endDate) < new Date(newAbsence.startDate)) {
                alert('La date de fin doit √™tre apr√®s la date de d√©but !');
                return;
            }
            
            scheduledAbsences.push(newAbsence);
            autoSave();
            showScheduledAbsencesModal(); // Recharger la modal
        }

        // Supprimer une absence programm√©e
        function deleteScheduledAbsence(index) {
            const absence = scheduledAbsences[index];
            const player = players.find(p => p.id === absence.playerId);
            const playerName = player ? `${player.prenom} ${player.nom}` : 'Joueur';
            
            if (confirm(`√ätes-vous s√ªr de vouloir supprimer le statut programm√© de ${playerName} ?`)) {
                scheduledAbsences.splice(index, 1);
                autoSave();
                showScheduledAbsencesModal(); // Recharger la modal
            }
        }

        // V√©rifier si un joueur a un statut programm√© √† une date donn√©e
        function getScheduledAbsence(playerId, date) {
            const sessionDate = new Date(date);
            
            return scheduledAbsences.find(absence => {
                if (absence.playerId !== playerId) return false;
                
                const startDate = new Date(absence.startDate);
                const endDate = new Date(absence.endDate);
                
                return sessionDate >= startDate && sessionDate <= endDate;
            });
        }

        // ===== INTERFACE MOBILE CARDS R√âVOLUTIONNAIRE =====
        
        let currentMobileSession = null;
        let mobileViewActive = false;

        // Activer/d√©sactiver la vue mobile
        function toggleMobileView() {
            if (!isMobileDevice()) return;
            
            mobileViewActive = !mobileViewActive;
            const mobileContainer = document.getElementById('mobilePresenceContainer');
            const desktopContainer = document.getElementById('desktopTableContainer');
            const toggleBtn = document.getElementById('mobileViewToggle');
            
            if (mobileViewActive) {
                mobileContainer.classList.add('active');
                desktopContainer.classList.add('mobile-hidden');
                toggleBtn.classList.add('cards-active');
                toggleBtn.innerHTML = 'üìä';
                toggleBtn.title = 'Basculer vers vue tableau';
                initializeMobileView();
            } else {
                mobileContainer.classList.remove('active');
                desktopContainer.classList.remove('mobile-hidden');
                toggleBtn.classList.remove('cards-active');
                toggleBtn.innerHTML = 'üì±';
                toggleBtn.title = 'Basculer vers vue cards';
            }
        }

        // Initialiser la vue mobile automatiquement
        function initializeMobileView() {
            if (isMobileDevice() && !mobileViewActive) {
                toggleMobileView();
            } else if (mobileViewActive) {
                renderMobileSessions();
                if (currentMobileSession) {
                    renderMobilePlayerCards();
                }
            }
        }

        // Rendu des sessions pour mobile
        function renderMobileSessions() {
            const buttonsContainer = document.getElementById('mobileSessionButtons');
            const filteredSessions = getFilteredSessions();
            
            buttonsContainer.innerHTML = '';
            
            filteredSessions.forEach((session, index) => {
                const btn = document.createElement('div');
                btn.className = 'session-btn';
                btn.onclick = () => selectMobileSession(session);
                
                if (index === 0 && !currentMobileSession) {
                    currentMobileSession = session;
                    btn.classList.add('active');
                }
                
                if (currentMobileSession && currentMobileSession.id === session.id) {
                    btn.classList.add('active');
                }
                
                const date = new Date(session.date);
                btn.innerHTML = `
                    <span class="session-date">${date.getDate()}/${date.getMonth() + 1}</span>
                    <span class="session-type">${session.type}</span>
                `;
                
                buttonsContainer.appendChild(btn);
            });
        }

        // S√©lectionner une session mobile
        function selectMobileSession(session) {
            currentMobileSession = session;
            
            // Mettre √† jour l'UI des boutons
            document.querySelectorAll('.session-btn').forEach(btn => btn.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            // Mettre √† jour l'indicateur
            const date = new Date(session.date);
            document.getElementById('currentSessionIndicator').innerHTML = 
                `üìÖ ${session.type} du ${date.toLocaleDateString('fr-FR')}`;
            
            // Render les cards
            renderMobilePlayerCards();
            
            // Haptic feedback
            if (navigator.vibrate) navigator.vibrate(30);
        }

        // Rendu des cards de joueurs
        function renderMobilePlayerCards() {
            if (!currentMobileSession) return;
            
            const container = document.getElementById('mobilePlayersList');
            const searchTerm = document.getElementById('mobileSearchInput').value.toLowerCase();
            
            // Filtrer et trier les joueurs
            let filteredPlayers = players.filter(player => {
                if (!searchTerm) return true;
                return player.prenom.toLowerCase().includes(searchTerm) || 
                       player.nom.toLowerCase().includes(searchTerm);
            });
            
            // Trier selon la s√©lection actuelle
            filteredPlayers = getSortedPlayers().filter(player => 
                filteredPlayers.some(fp => fp.id === player.id)
            );
            
            container.innerHTML = '';
            
            filteredPlayers.forEach(player => {
                const status = presences[player.id][currentMobileSession.id] || 'rep';
                const card = createMobilePlayerCard(player, status);
                container.appendChild(card);
            });
            
            if (filteredPlayers.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6c757d;">
                        <div style="font-size: 3em; margin-bottom: 15px;">üîç</div>
                        <div>Aucun joueur trouv√©</div>
                    </div>
                `;
            }
        }

        // Cr√©er une card de joueur avec gestes swipe
        function createMobilePlayerCard(player, currentStatus) {
            const card = document.createElement('div');
            card.className = `mobile-player-card status-${currentStatus}`;
            card.dataset.playerId = player.id;
            
            const statusLabels = {
                'pst': 'Pr√©sent',
                'abp': 'Absent Pr√©venu', 
                'absp': 'Absent Sans Pr√©venir',
                'bls': 'Bless√©',
                'vac': 'Vacances',
                'rep': 'Repos',
                'ca': 'Convoqu√© A',
                'cb': 'Convoqu√© B',
                'cc': 'Convoqu√© C',
                'ret': 'Retard'
            };
            
            const statusColors = {
                'pst': '#28a745',
                'abp': '#ffc107', 
                'absp': '#dc3545',
                'bls': '#fd7e14',
                'vac': '#17a2b8',
                'rep': '#6c757d',
                'ca': '#20c997',
                'cb': '#20c997',
                'cc': '#20c997',
                'ret': '#e83e8c'
            };
            
            card.innerHTML = `
                <div class="mobile-player-header">
                    <div class="mobile-player-name">${player.prenom} ${player.nom}</div>
                    <div class="mobile-current-status" style="background: ${statusColors[currentStatus]}">
                        ${statusLabels[currentStatus] || currentStatus.toUpperCase()}
                    </div>
                </div>
                <div style="margin-top: 15px; text-align: center; color: #6c757d; font-size: 0.9em;">
                    <div>üëà Absent ‚Ä¢ üëâ Pr√©sent ‚Ä¢ üëÜ Repos ‚Ä¢ üëá Menu</div>
                </div>
                
                <!-- Indicateurs de swipe -->
                <div class="mobile-swipe-indicator left">‚ùå</div>
                <div class="mobile-swipe-indicator right">‚úÖ</div>
                <div class="mobile-swipe-indicator up">üò¥</div>
                <div class="mobile-swipe-indicator down">üìã</div>
            `;
            
            // Ajouter les √©v√©nements de swipe
            addSwipeGestures(card, player);
            
            return card;
        }

        // Ajouter les gestes de swipe aux cards
        function addSwipeGestures(card, player) {
            let startX = null;
            let startY = null;
            let currentX = null;
            let currentY = null;
            let isDragging = false;
            
            // √âv√©nements tactiles
            card.addEventListener('touchstart', handleTouchStart, {passive: false});
            card.addEventListener('touchmove', handleTouchMove, {passive: false});
            card.addEventListener('touchend', handleTouchEnd, {passive: false});
            
            function handleTouchStart(e) {
                const touch = e.touches[0];
                startX = touch.clientX;
                startY = touch.clientY;
                currentX = startX;
                currentY = startY;
                isDragging = true;
                
                // Emp√™cher le scroll pendant le swipe
                e.preventDefault();
            }
            
            function handleTouchMove(e) {
                if (!isDragging) return;
                
                const touch = e.touches[0];
                currentX = touch.clientX;
                currentY = touch.clientY;
                
                const deltaX = currentX - startX;
                const deltaY = currentY - startY;
                const absDeltaX = Math.abs(deltaX);
                const absDeltaY = Math.abs(deltaY);
                
                // D√©terminer la direction principale
                if (absDeltaX > absDeltaY && absDeltaX > 30) {
                    // Swipe horizontal
                    card.classList.remove('swipe-up', 'swipe-down');
                    if (deltaX < 0) {
                        // Swipe gauche - Absent
                        card.classList.remove('swipe-right');
                        card.classList.add('swipe-left');
                        showSwipeIndicator(card, 'left');
                    } else {
                        // Swipe droite - Pr√©sent
                        card.classList.remove('swipe-left');
                        card.classList.add('swipe-right');
                        showSwipeIndicator(card, 'right');
                    }
                } else if (absDeltaY > absDeltaX && absDeltaY > 30) {
                    // Swipe vertical
                    card.classList.remove('swipe-left', 'swipe-right');
                    if (deltaY < 0) {
                        // Swipe haut - Repos
                        card.classList.remove('swipe-down');
                        card.classList.add('swipe-up');
                        showSwipeIndicator(card, 'up');
                    } else {
                        // Swipe bas - Menu
                        card.classList.remove('swipe-up');
                        card.classList.add('swipe-down');
                        showSwipeIndicator(card, 'down');
                    }
                } else {
                    // Pas assez de mouvement
                    resetCardState(card);
                }
                
                e.preventDefault();
            }
            
            function handleTouchEnd(e) {
                if (!isDragging) return;
                isDragging = false;
                
                const deltaX = currentX - startX;
                const deltaY = currentY - startY;
                const absDeltaX = Math.abs(deltaX);
                const absDeltaY = Math.abs(deltaY);
                
                // Seuil pour d√©clencher l'action
                const threshold = 80;
                
                if (absDeltaX > absDeltaY && absDeltaX > threshold) {
                    if (deltaX < 0) {
                        // Swipe gauche confirm√© - Absent
                        executeSwipeAction(player, 'absent');
                    } else {
                        // Swipe droite confirm√© - Pr√©sent  
                        executeSwipeAction(player, 'present');
                    }
                } else if (absDeltaY > absDeltaX && absDeltaY > threshold) {
                    if (deltaY < 0) {
                        // Swipe haut confirm√© - Repos
                        executeSwipeAction(player, 'repos');
                    } else {
                        // Swipe bas confirm√© - Menu complet
                        showFullStatusMenu(player, card);
                    }
                }
                
                // Reset de l'√©tat visuel
                setTimeout(() => resetCardState(card), 200);
            }
        }
        
        // Afficher l'indicateur de swipe
        function showSwipeIndicator(card, direction) {
            // Masquer tous les indicateurs
            card.querySelectorAll('.mobile-swipe-indicator').forEach(indicator => {
                indicator.classList.remove('show');
            });
            
            // Afficher l'indicateur appropri√©
            const indicator = card.querySelector(`.mobile-swipe-indicator.${direction}`);
            if (indicator) {
                indicator.classList.add('show');
            }
        }
        
        // R√©initialiser l'√©tat de la card
        function resetCardState(card) {
            card.classList.remove('swipe-left', 'swipe-right', 'swipe-up', 'swipe-down');
            card.querySelectorAll('.mobile-swipe-indicator').forEach(indicator => {
                indicator.classList.remove('show');
            });
        }
        
        // Ex√©cuter l'action de swipe
        function executeSwipeAction(player, action) {
            if (!currentMobileSession) return;
            
            let newStatus = 'rep'; // d√©faut
            
            switch(action) {
                case 'present':
                    newStatus = 'pst';
                    break;
                case 'absent':
                    // Cycle entre les types d'absence
                    const currentStatus = presences[player.id][currentMobileSession.id];
                    if (currentStatus === 'abp') {
                        newStatus = 'absp';
                    } else if (currentStatus === 'absp') {
                        newStatus = 'bls';
                    } else {
                        newStatus = 'abp';
                    }
                    break;
                case 'repos':
                    newStatus = 'rep';
                    break;
            }
            
            // Mettre √† jour le statut
            updateMobileStatus(player.id, newStatus);
        }
        
        // Afficher le menu complet des statuts
        function showFullStatusMenu(player, card) {
            const statusOptions = [
                {code: 'pst', label: '‚úÖ Pr√©sent', color: '#28a745'},
                {code: 'abp', label: '‚ö†Ô∏è Absent Pr√©venu', color: '#ffc107'},
                {code: 'absp', label: '‚ùå Absent Sans Pr√©venir', color: '#dc3545'},
                {code: 'bls', label: 'ü§ï Bless√©', color: '#fd7e14'},
                {code: 'vac', label: 'üèñÔ∏è Vacances', color: '#17a2b8'},
                {code: 'rep', label: 'üò¥ Repos', color: '#6c757d'},
                {code: 'ca', label: 'ü•á Convoqu√© A', color: '#20c997'},
                {code: 'cb', label: 'ü•à Convoqu√© B', color: '#20c997'},
                {code: 'cc', label: 'ü•â Convoqu√© C', color: '#20c997'},
                {code: 'ret', label: '‚è∞ Retard', color: '#e83e8c'}
            ];
            
            const menuHtml = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 20px;" onclick="this.remove()">
                    <div style="background: white; border-radius: 16px; padding: 20px; max-width: 300px; width: 100%;" onclick="event.stopPropagation()">
                        <h3 style="margin: 0 0 20px 0; text-align: center; color: #2c3e50;">
                            ${player.prenom} ${player.nom}
                        </h3>
                        <div style="display: grid; grid-template-columns: 1fr; gap: 8px;">
                            ${statusOptions.map(option => `
                                <button style="padding: 15px; border: none; border-radius: 8px; background: ${option.color}; color: white; font-size: 1em; font-weight: 600; cursor: pointer; transition: all 0.2s;" 
                                        onclick="updateMobileStatus(${player.id}, '${option.code}'); this.closest('[style*=\"position: fixed\"]').remove();"
                                        onmousedown="this.style.transform='scale(0.95)'"
                                        onmouseup="this.style.transform='scale(1)'">
                                    ${option.label}
                                </button>
                            `).join('')}
                        </div>
                        <button onclick="this.closest('[style*=\"position: fixed\"]').remove()" 
                                style="width: 100%; margin-top: 15px; padding: 12px; border: 2px solid #dee2e6; border-radius: 8px; background: white; color: #6c757d; font-weight: 600; cursor: pointer;">
                            Annuler
                        </button>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', menuHtml);
            
            // Haptic feedback
            if (navigator.vibrate) navigator.vibrate([50, 50, 50]);
        }

        // Mettre √† jour le statut depuis mobile (version simplifi√©e)
        function updateMobileStatus(playerId, newStatus) {
            if (!currentMobileSession) return;
            
            // Mettre √† jour les donn√©es
            presences[playerId][currentMobileSession.id] = newStatus;
            updateStats();
            autoSave();
            
            // Haptic feedback
            if (navigator.vibrate) navigator.vibrate(60);
            
            // Mettre √† jour l'affichage
            setTimeout(() => {
                renderMobilePlayerCards();
            }, 200);
        }

        // Animation de feedback
        function showStatusFeedback(buttonElement, status) {
            const feedback = document.createElement('div');
            feedback.className = 'mobile-status-feedback';
            
            const icons = {
                'pst': '‚úÖ',
                'abp': '‚ö†Ô∏è', 
                'absp': '‚ùå',
                'bls': 'ü§ï',
                'vac': 'üèñÔ∏è',
                'rep': 'üò¥',
                'ca': 'ü•á',
                'cb': 'ü•à',
                'cc': 'ü•â',
                'ret': '‚è∞'
            };
            
            feedback.innerHTML = icons[status] || '‚ú®';
            buttonElement.appendChild(feedback);
            
            setTimeout(() => feedback.remove(), 600);
        }

        // Fonction de filtrage mobile
        function filterMobilePlayers() {
            renderMobilePlayerCards();
        }

        // Obtenir les sessions filtr√©es (r√©utilisation de la fonction existante ou nouvelle)
        function getFilteredSessions() {
            if (typeof getFilteredSessionsForPeriod === 'function') {
                return getFilteredSessionsForPeriod();
            }
            
            // Fallback : toutes les sessions tri√©es par date (plus r√©cente √† gauche)
            return sessions.slice().sort((a, b) => b.date.localeCompare(a.date));
        }

        // Modal pour l'export PDF personnalis√©
        function showExportPDFModal() {
            const today = new Date().toISOString().split('T')[0];
            
            let modalHtml = `
                <h2>üìä Export PDF Personnalis√©</h2>
                
                <div style="background: #f8f9ff; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3>üóìÔ∏è S√©lectionner la p√©riode</h3>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 10px;">
                            <input type="radio" name="periodType" value="single" checked onchange="updatePeriodInputs()">
                            Un seul entra√Ænement
                        </label>
                        <label style="display: block; margin-bottom: 10px;">
                            <input type="radio" name="periodType" value="week" onchange="updatePeriodInputs()">
                            Une semaine compl√®te
                        </label>
                        <label style="display: block; margin-bottom: 10px;">
                            <input type="radio" name="periodType" value="month" onchange="updatePeriodInputs()">
                            Un mois entier
                        </label>
                        <label style="display: block; margin-bottom: 10px;">
                            <input type="radio" name="periodType" value="range" onchange="updatePeriodInputs()">
                            P√©riode personnalis√©e
                        </label>
                    </div>
                    
                    <div style="background: #f0f8ff; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 15px 0;">üèÉ‚Äç‚ôÇÔ∏è Filtrer par type d'activit√©</h4>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="radio" name="sessionTypeFilter" value="all" checked onchange="updatePreview()">
                                Tout
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="radio" name="sessionTypeFilter" value="Entra√Ænement" onchange="updatePreview()">
                                Entra√Ænements uniquement
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="radio" name="sessionTypeFilter" value="Match" onchange="updatePreview()">
                                Matchs uniquement
                            </label>
                        </div>
                    </div>
                    
                    <div id="periodInputs">
                        <div class="form-group">
                            <label>S√©lectionner l'entra√Ænement :</label>
                            <select id="singleSession" style="width: 100%; padding: 8px;">
                                ${sessions.map(s => `<option value="${s.id}">${s.type} - ${new Date(s.date).toLocaleDateString('fr-FR')}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    
                    <div id="previewSection" style="margin-top: 20px; padding: 15px; background: #f0f0f0; border-radius: 8px;">
                        <h4>Aper√ßu des donn√©es</h4>
                        <p id="previewText">S√©lectionnez une p√©riode pour voir l'aper√ßu</p>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <button class="btn btn-success" onclick="generateCustomPDF()">üìÑ G√©n√©rer le PDF</button>
                        <button class="btn btn-secondary" onclick="closeModal()">Annuler</button>
                    </div>
                </div>
            `;
            
            showModal(modalHtml);
            updatePeriodInputs();
        }

        // Mettre √† jour les champs selon le type de p√©riode s√©lectionn√©
        function updatePeriodInputs() {
            const periodType = document.querySelector('input[name="periodType"]:checked').value;
            const periodInputsDiv = document.getElementById('periodInputs');
            const today = new Date().toISOString().split('T')[0];
            
            let inputsHtml = '';
            
            switch(periodType) {
                case 'single':
                    const sessionTypeFilter = document.querySelector('input[name="sessionTypeFilter"]:checked')?.value || 'all';
                    let availableSessions = sessions;
                    if (sessionTypeFilter !== 'all') {
                        availableSessions = sessions.filter(s => s.type === sessionTypeFilter);
                    }
                    
                    inputsHtml = `
                        <div class="form-group">
                            <label>S√©lectionner l'entra√Ænement :</label>
                            <select id="singleSession" style="width: 100%; padding: 8px;" onchange="updatePreview()">
                                ${availableSessions.map(s => `<option value="${s.id}">${s.type} - ${new Date(s.date).toLocaleDateString('fr-FR')}</option>`).join('')}
                            </select>
                        </div>
                    `;
                    break;
                    
                case 'week':
                    inputsHtml = `
                        <div class="form-group">
                            <label>S√©lectionner la semaine :</label>
                            <input type="week" id="weekSelect" value="${getCurrentWeek()}" style="width: 100%; padding: 8px;" onchange="updatePreview()">
                        </div>
                    `;
                    break;
                    
                case 'month':
                    inputsHtml = `
                        <div class="form-group">
                            <label>S√©lectionner le mois :</label>
                            <input type="month" id="monthSelect" value="${today.substring(0, 7)}" style="width: 100%; padding: 8px;" onchange="updatePreview()">
                        </div>
                    `;
                    break;
                    
                case 'range':
                    inputsHtml = `
                        <div class="form-group">
                            <label>Date de d√©but :</label>
                            <input type="date" id="startDate" value="${today}" style="width: 100%; padding: 8px;" onchange="updatePreview()">
                        </div>
                        <div class="form-group">
                            <label>Date de fin :</label>
                            <input type="date" id="endDate" value="${today}" style="width: 100%; padding: 8px;" onchange="updatePreview()">
                        </div>
                    `;
                    break;
            }
            
            periodInputsDiv.innerHTML = inputsHtml;
            updatePreview();
        }

        // Obtenir la semaine actuelle au format YYYY-Www
        function getCurrentWeek() {
            const date = new Date();
            const year = date.getFullYear();
            const oneJan = new Date(date.getFullYear(), 0, 1);
            const numberOfDays = Math.floor((date - oneJan) / (24 * 60 * 60 * 1000));
            const weekNumber = Math.ceil((date.getDay() + 1 + numberOfDays) / 7);
            return `${year}-W${weekNumber.toString().padStart(2, '0')}`;
        }

        // Mettre √† jour l'aper√ßu
        function updatePreview() {
            const periodType = document.querySelector('input[name="periodType"]:checked').value;
            const previewText = document.getElementById('previewText');
            const sessionTypeFilter = document.querySelector('input[name="sessionTypeFilter"]:checked')?.value || 'all';
            
            const filteredSessions = getFilteredSessions();
            
            if (filteredSessions.length === 0) {
                const filterText = sessionTypeFilter === 'all' ? '' : ` (${sessionTypeFilter.toLowerCase()}s)`;
                previewText.textContent = `Aucune session trouv√©e pour cette p√©riode${filterText}`;
            } else {
                const trainingsCount = filteredSessions.filter(s => s.type === 'Entra√Ænement').length;
                const matchesCount = filteredSessions.filter(s => s.type === 'Match').length;
                const typeText = sessionTypeFilter === 'all' 
                    ? `(${trainingsCount} entra√Ænements, ${matchesCount} matchs)`
                    : `(${sessionTypeFilter.toLowerCase()}s uniquement)`;
                
                previewText.innerHTML = `
                    <strong>Sessions trouv√©es :</strong> ${filteredSessions.length} ${typeText}<br>
                    <strong>Premi√®re session :</strong> ${new Date(filteredSessions[0].date).toLocaleDateString('fr-FR')}<br>
                    <strong>Derni√®re session :</strong> ${new Date(filteredSessions[filteredSessions.length - 1].date).toLocaleDateString('fr-FR')}
                `;
            }
        }

        // Obtenir les sessions filtr√©es selon la p√©riode s√©lectionn√©e
        function getFilteredSessions() {
            const periodType = document.querySelector('input[name="periodType"]:checked').value;
            let filteredSessions = [];
            
            switch(periodType) {
                case 'single':
                    const sessionId = document.getElementById('singleSession').value;
                    filteredSessions = sessions.filter(s => s.id == sessionId);
                    break;
                    
                case 'week':
                    const weekValue = document.getElementById('weekSelect').value;
                    if (weekValue) {
                        const [year, week] = weekValue.split('-W');
                        const startDate = getDateOfWeek(parseInt(week), parseInt(year));
                        const endDate = new Date(startDate);
                        endDate.setDate(endDate.getDate() + 6);
                        
                        filteredSessions = sessions.filter(s => {
                            const sessionDate = new Date(s.date);
                            return sessionDate >= startDate && sessionDate <= endDate;
                        });
                    }
                    break;
                    
                case 'month':
                    const monthValue = document.getElementById('monthSelect').value;
                    if (monthValue) {
                        const [year, month] = monthValue.split('-');
                        filteredSessions = sessions.filter(s => {
                            const sessionDate = new Date(s.date);
                            return sessionDate.getFullYear() == year && (sessionDate.getMonth() + 1) == month;
                        });
                    }
                    break;
                    
                case 'range':
                    const startDate = new Date(document.getElementById('startDate').value);
                    const endDate = new Date(document.getElementById('endDate').value);
                    
                    filteredSessions = sessions.filter(s => {
                        const sessionDate = new Date(s.date);
                        return sessionDate >= startDate && sessionDate <= endDate;
                    });
                    break;
            }
            
            // Appliquer le filtre de type de session
            const sessionTypeFilter = document.querySelector('input[name="sessionTypeFilter"]:checked')?.value || 'all';
            if (sessionTypeFilter !== 'all') {
                filteredSessions = filteredSessions.filter(s => s.type === sessionTypeFilter);
            }
            
            return filteredSessions.sort((a, b) => new Date(a.date) - new Date(b.date));
        }

        // Obtenir la date du d√©but d'une semaine
        function getDateOfWeek(week, year) {
            const date = new Date(year, 0, 1);
            const dayOfWeek = date.getDay();
            const daysToMonday = (dayOfWeek === 0 ? -6 : 1) - dayOfWeek;
            date.setDate(date.getDate() + daysToMonday);
            date.setDate(date.getDate() + (week - 1) * 7);
            return date;
        }

        // G√©n√©rer le PDF personnalis√©
        function generateCustomPDF() {
            const filteredSessions = getFilteredSessions();
            
            if (filteredSessions.length === 0) {
                alert('Aucune session trouv√©e pour cette p√©riode');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('landscape');
            
            // En-t√™te avec filtrage par type
            doc.setFontSize(20);
            const sessionTypeFilter = document.querySelector('input[name="sessionTypeFilter"]:checked')?.value || 'all';
            let titleText = 'Senior - Rapport de Pr√©sences';
            if (sessionTypeFilter === 'Entra√Ænement') {
                titleText = 'Senior - Rapport de Pr√©sences (Entra√Ænements)';
            } else if (sessionTypeFilter === 'Match') {
                titleText = 'Senior - Rapport de Pr√©sences (Matchs)';
            }
            doc.text(titleText, 148, 20, { align: 'center' });
            
            // P√©riode
            doc.setFontSize(12);
            const periodType = document.querySelector('input[name="periodType"]:checked').value;
            let periodText = '';
            
            switch(periodType) {
                case 'single':
                    periodText = `Session du ${new Date(filteredSessions[0].date).toLocaleDateString('fr-FR')} (${filteredSessions[0].type})`;
                    break;
                case 'week':
                    periodText = `Semaine du ${new Date(filteredSessions[0].date).toLocaleDateString('fr-FR')} au ${new Date(filteredSessions[filteredSessions.length - 1].date).toLocaleDateString('fr-FR')}`;
                    break;
                case 'month':
                    const monthNames = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];
                    const sessionDate = new Date(filteredSessions[0].date);
                    periodText = `${monthNames[sessionDate.getMonth()]} ${sessionDate.getFullYear()}`;
                    break;
                case 'range':
                    periodText = `Du ${new Date(filteredSessions[0].date).toLocaleDateString('fr-FR')} au ${new Date(filteredSessions[filteredSessions.length - 1].date).toLocaleDateString('fr-FR')}`;
                    break;
            }
            
            // Ajouter info sur le type de sessions si filtr√©
            if (sessionTypeFilter !== 'all') {
                const trainingsCount = filteredSessions.filter(s => s.type === 'Entra√Ænement').length;
                const matchesCount = filteredSessions.filter(s => s.type === 'Match').length;
                periodText += ` - ${filteredSessions.length} ${sessionTypeFilter.toLowerCase()}${filteredSessions.length > 1 ? 's' : ''}`;
            }
            
            doc.text(periodText, 148, 30, { align: 'center' });
            
            // Pr√©parer les donn√©es du tableau
            const tableData = players.map(player => {
                const row = [player.prenom, player.nom];
                let totalPresent = 0;
                let totalAbsent = 0;
                
                filteredSessions.forEach(session => {
                    const status = presences[player.id][session.id];
                    row.push(status.toUpperCase());
                    
                    if (status === 'pst' || status === 'ca' || status === 'cb' || status === 'cc') {
                        totalPresent++;
                    } else if (status === 'abp' || status === 'absp' || status === 'bls') {
                        totalAbsent++;
                    }
                });
                
                // Ajouter les totaux
                const rate = filteredSessions.length > 0 ? Math.round((totalPresent / filteredSessions.length) * 100) : 0;
                row.push(totalPresent.toString());
                row.push(totalAbsent.toString());
                row.push(`${rate}%`);
                
                return row;
            });
            
            // Headers du tableau
            const headers = ['Pr√©nom', 'Nom'];
            filteredSessions.forEach(session => {
                headers.push(new Date(session.date).toLocaleDateString('fr-FR').substring(0, 5));
            });
            headers.push('Pr√©sences', 'Absences', 'Taux');
            
            // G√©n√©rer le tableau
            doc.autoTable({
                head: [headers],
                body: tableData,
                startY: 40,
                theme: 'grid',
                headStyles: { fillColor: [33, 150, 243] },
                styles: { fontSize: 8, cellPadding: 2 },
                columnStyles: {
                    0: { cellWidth: 25 },
                    1: { cellWidth: 25 }
                }
            });
            
            // L√©gende
            const finalY = doc.lastAutoTable.finalY + 10;
            doc.setFontSize(10);
            doc.text('L√©gende: PST=Pr√©sent, AbP=Absent Pr√©venu, AbSP=Absent Sans Pr√©venir, BLS=Bless√©, VAC=Vacances, REP=Repos, RET=Retard', 14, finalY);
            
            // Sauvegarder le PDF
            let fileName = `presences_senior_${periodText.replace(/\//g, '-').replace(/ /g, '_')}`;
            if (sessionTypeFilter !== 'all') {
                fileName = fileName.replace('.pdf', '') + `_${sessionTypeFilter.toLowerCase()}s.pdf`;
            } else {
                fileName += '.pdf';
            }
            doc.save(fileName);
            
            closeModal();
        }

    </script>
</body>
</html>

